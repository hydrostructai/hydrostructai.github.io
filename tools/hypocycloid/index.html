<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quỹ Đạo Hypocycloid</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #212529; /* Đen nhạt */
            --primary-color: #007bff; /* Xanh dương */
            --secondary-color: #6c757d; /* Xám */
            --danger-color: #D0021B;  /* Đỏ cho quỹ đạo */
            --border-color: #dee2e6;  /* Xám nhạt cho viền */
            --control-bg: rgba(255, 255, 255, 0.85); /* Nền trắng mờ */
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            
            /* --- SỬA LOGIC LAYOUT --- */
            display: flex;
            flex-direction: row; /* Mặc định là side-by-side */
            height: 100vh;
            overflow: hidden;
            /* --- KẾT THÚC SỬA --- */
        }

        canvas {
            display: block;
            flex-grow: 1; /* Canvas lấp đầy không gian còn lại */
        }

        /* --- SỬA LOGIC LAYOUT (Bảng điều khiển) --- */
        #controls-panel {
            /* Gỡ bỏ position: absolute để đưa vào luồng flex */
            /* position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            */
            
            /* Giao diện hiện đại */
            background-color: #f8f9fa; /* Đổi sang màu nền đục cho dễ đọc */
            border-left: 1px solid var(--border-color); /* Thêm viền trái */
            border-radius: 0; /* Bỏ border radius */
            box-shadow: var(--box-shadow);
            /* backdrop-filter: blur(5px); */ /* Bỏ blur */
            
            padding: 20px;
            box-sizing: border-box;
            
            /* Bố cục flex */
            display: flex;
            flex-direction: column; /* Xếp chồng các nhóm input */
            gap: 20px;
            
            /* Kích thước & Cuộn */
            width: 350px; /* Đặt chiều rộng cố định */
            flex-shrink: 0; /* Không cho co lại */
            height: 100vh; /* Cao 100% */
            overflow-y: auto; /* Cho phép cuộn nếu không đủ chỗ */
        }
        /* --- KẾT THÚC SỬA --- */

        .input-group {
            display: flex;
            flex-direction: column; /* Sửa: Xếp chồng các input-item */
            gap: 15px;
        }

        .input-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--secondary-color);
        }

        input[type="number"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            width: 100%; /* Sửa: Chiếm 100% chiều rộng của control panel */
            box-sizing: border-box; /* Thêm box-sizing */
        }

        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%; /* Sửa: Chiếm 100% chiều rộng */
            height: 38px;
            padding: 0;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
        }

        /* Sửa: Bố cục nhóm màu sắc */
        .color-input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .button-group {
            display: flex;
            flex-direction: column; /* Sửa: Xếp chồng các nút */
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
            background-color: var(--primary-color);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        /* --- SỬA CSS RESPONSIVE (MOBILE) --- */
        @media (max-width: 768px) {
            body {
                flex-direction: column; /* Xếp chồng: canvas trên, controls dưới */
            }

            #controls-panel {
                width: 100%; /* Chiếm 100% chiều rộng */
                height: auto; /* Chiều cao tự động */
                flex-shrink: 1;
                flex-direction: column; /* Vẫn là cột */
                border-left: none; /* Bỏ viền trái */
                border-top: 1px solid var(--border-color); /* Thêm viền trên */
            }

            .input-group {
                flex-direction: row; /* Quay lại thành hàng trên mobile */
                justify-content: space-around;
            }

            .color-input-grid {
                grid-template-columns: 1fr 1fr 1fr 1fr; /* Dàn 4 màu ra */
            }

            .button-group {
                flex-direction: row; /* Nút cũng thành hàng */
            }
        }
        /* --- KẾT THÚC SỬA --- */
    </style>
</head>
<body>
    <canvas id="hypocycloidCanvas"></canvas>

    <div id="controls-panel">
        
        <div class="input-group">
            <div class="input-item">
                <label for="largeRadius">Bán kính lớn (R)</label>
                <input type="number" id="largeRadius" value="200" step="10">
            </div>
            <div class="input-item">
                <label for="smallRadius">Bán kính nhỏ (r)</label>
                <input type="number" id="smallRadius" value="40" step="5">
            </div>
            <div class="input-item">
                <label for="speed">Tốc độ (speed)</label>
                <input type="number" id="speed" value="0.05" step="0.01">
            </div>
        </div>
        
        <div class="input-group">
            <label>Màu sắc</label>
            <div class="color-input-grid">
                <div class="input-item">
                    <label for="bgColor">Nền</label>
                    <input type="color" id="bgColor" value="#ffffff">
                </div>
                <div class="input-item">
                    <label for="largeCircleColor">Vòng lớn</label>
                    <input type="color" id="largeCircleColor" value="#4A90E2">
                </div>
                <div class="input-item">
                    <label for="smallCircleColor">Vòng nhỏ</label>
                    <input type="color" id="smallCircleColor" value="#333333">
                </div>
                <div class="input-item">
                    <label for="pathColor">Quỹ đạo</label>
                    <input type="color" id="pathColor" value="#D0021B">
                </div>
            </div>
        </div>

        <div class="button-group">
            <button id="runBtn">Vẽ Quỹ Đạo</button>
            <button id="resetBtn">Đặt Lại</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('hypocycloidCanvas');
        const ctx = canvas.getContext('2d');
        const largeRadiusInput = document.getElementById('largeRadius');
        const smallRadiusInput = document.getElementById('smallRadius');
        const speedInput = document.getElementById('speed');
        const runBtn = document.getElementById('runBtn');
        const resetBtn = document.getElementById('resetBtn');

        const bgColorInput = document.getElementById('bgColor');
        const largeCircleColorInput = document.getElementById('largeCircleColor');
        const smallCircleColorInput = document.getElementById('smallCircleColor');
        const pathColorInput = document.getElementById('pathColor');

        let R, r, speed, path = [], angle = 0, isRunning = false, animationFrameId;

        function setCanvasSize() {
            // Sửa: Lấy kích thước từ body để đảm bảo full màn hình
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            // Đặt gốc tọa độ về giữa
            ctx.translate(canvas.width / 2, canvas.height / 2);
        }

        // --- SỬA LỖI RESPONSIVE ---
        // Gọi hàm reset khi thay đổi kích thước cửa sổ
        // để xóa quỹ đạo cũ và vẽ lại trên canvas mới
        window.addEventListener('resize', reset);
        // --- KẾT THÚC SỬA LỖI ---

        function drawStaticElements() {
            // Đặt lại ma trận transform về mặc định
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            
            // Xóa toàn bộ canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Vẽ nền
            ctx.fillStyle = bgColorInput.value;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Di chuyển gốc tọa độ về giữa
            ctx.translate(canvas.width / 2, canvas.height / 2);

            // Vẽ vòng tròn lớn (nếu R đã được định nghĩa)
            if (R) {
                ctx.beginPath();
                ctx.strokeStyle = largeCircleColorInput.value;
                ctx.lineWidth = 2;
                ctx.arc(0, 0, R, 0, 2 * Math.PI);
                ctx.stroke();
            }
        }

        function animate() {
            if (!isRunning) return;

            // Vẽ các thành phần tĩnh (Nền, Vòng lớn)
            drawStaticElements();

            // Tính toán tọa độ
            const Cx = (R - r) * Math.cos(angle);
            const Cy = (R - r) * Math.sin(angle);
            
            // Sửa lại công thức Hypocycloid cho đúng
            // Tọa độ điểm vẽ (x, y)
            const x = (R - r) * Math.cos(angle) + r * Math.cos(((R - r) / r) * angle);
            const y = (R - r) * Math.sin(angle) - r * Math.sin(((R - r) / r) * angle);

            // Thêm điểm vào quỹ đạo
            path.push({x, y});

            // Vẽ vòng tròn nhỏ
            ctx.beginPath();
            ctx.strokeStyle = smallCircleColorInput.value;
            ctx.lineWidth = 2;
            ctx.arc(Cx, Cy, r, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Vẽ điểm trên vòng tròn nhỏ
            ctx.beginPath();
            ctx.fillStyle = pathColorInput.value;
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
            
            // Vẽ đường nối tâm vòng nhỏ tới điểm vẽ
            ctx.beginPath();
            ctx.strokeStyle = smallCircleColorInput.value;
            ctx.lineWidth = 1;
            ctx.moveTo(Cx, Cy);
            ctx.lineTo(x, y);
            ctx.stroke();

            // Vẽ quỹ đạo
            ctx.beginPath();
            ctx.strokeStyle = pathColorInput.value;
            ctx.lineWidth = 2;
            for (let i = 0; i < path.length; i++) {
                // Sử dụng lineto cho điểm đầu tiên nếu là điểm bắt đầu
                (i === 0) ? ctx.moveTo(path[i].x, path[i].y) : ctx.lineTo(path[i].x, path[i].y);
            }
            ctx.stroke();
            
            angle += speed;

            // Sửa điều kiện dừng: Dừng khi vòng nhỏ quay đủ số vòng
            // (Số vòng quay của vòng nhỏ = R / r)
            const totalRevolutions = R / r;
            if (angle < totalRevolutions * 2 * Math.PI + speed) {
                animationFrameId = requestAnimationFrame(animate);
            } else {
                isRunning = false;
                runBtn.textContent = 'Vẽ Lại';
            }
        }

        function runAnimation() {
            // Nếu đang chạy, reset trước khi chạy lại
            if (isRunning) {
                reset();
            }

            R = parseFloat(largeRadiusInput.value);
            r = parseFloat(smallRadiusInput.value);
            speed = parseFloat(speedInput.value);
            path = [];
            angle = 0;
            isRunning = true;
            runBtn.textContent = 'Đang vẽ...';
            
            // Vẽ các thành phần tĩnh trước khi bắt đầu
            setCanvasSize();
            drawStaticElements(); 
            
            animationFrameId = requestAnimationFrame(animate);
        }

        function reset() {
            cancelAnimationFrame(animationFrameId);
            isRunning = false;
            runBtn.textContent = 'Vẽ Quỹ Đạo';
            path = [];
            angle = 0;
            
            // Lấy giá trị R hiện tại để vẽ vòng tĩnh
            R = parseFloat(largeRadiusInput.value); 
            
            setCanvasSize();
            drawStaticElements(); // Vẽ lại nền và vòng lớn tĩnh
        }

        runBtn.addEventListener('click', runAnimation);
        resetBtn.addEventListener('click', reset);
        
        // Khởi tạo ban đầu
        R = parseFloat(largeRadiusInput.value); // Lấy R để vẽ lần đầu
        setCanvasSize();
        drawStaticElements();
    </script>
</body>
</html>