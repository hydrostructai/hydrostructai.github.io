<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pile Group 3D Analysis</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <link href="../../assets/css/global.css" rel="stylesheet">
    
    <link href="app.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">
        <i class="bi bi-hourglass-split"></i> Đang khởi tạo mô hình 3D...
    </div>
</div>

<div class="container my-4">
    <div class="row">
        <div class="col-lg-3 mb-4">
            <div class="card p-3 sticky-top sidebar-card" style="top: 1rem;">
                <h4>File Management</h4>
                <hr>
                
                <div class="btn-group w-100 mb-3" role="group">
                    <button type="button" class="btn btn-outline-primary" id="btn-new-file" title="Tạo mới">
                        <i class="bi bi-file-earmark-plus"></i> New
                    </button>
                    <button type="button" class="btn btn-outline-success" id="btn-open-file" title="Mở file"
                            onclick="AppUI.file.triggerOpen('hidden-file-input')">
                        <i class="bi bi-folder-open"></i> Open
                    </button>
                    <button type="button" class="btn btn-outline-warning" id="btn-save-file" title="Lưu file">
                        <i class="bi bi-save"></i> Save
                    </button>
                </div>
                <input type="file" id="hidden-file-input" accept=".csv,.inp" style="display:none;">
                
                <button class="btn btn-lg btn-success w-100 shadow-sm" id="calculate-button" disabled>
                    <i class="bi bi-calculator"></i> TÍNH TOÁN
                </button>
                
                <div class="alert alert-info mt-3 shadow-sm" id="wasm-status">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary spinner-border-sm me-2" role="status" id="wasm-spinner"></div>
                        <span id="wasm-status-text">Đang tải lõi tính toán...</span>
                    </div>
                </div>
                <div class="alert alert-danger mt-3 shadow-sm" id="error-message" style="display: none;"></div>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h3 class="mb-0 text-primary"><i class="bi bi-grid-3x3-gap-fill"></i> Bệ cọc đài cao 3D (Zavriev-Spiro)</h3>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="inputTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#content-material">1. Vật liệu & Bệ</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-soil">2. Đất nền</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-loads">3. Tải trọng</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-piles">4. Bố trí cọc</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-license"><i class="bi bi-patch-check"></i> 5. Bản quyền</button></li>
                    </ul>
                    
                    <div class="tab-content p-3 border border-top-0" id="inputTabsContent">
                        
                        <div class="tab-pane fade show active" id="content-material">
                            <h5><i class="bi bi-rulers"></i> Thông số cọc (Pile Properties)</h5>
                            <hr>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-medium">Mô đun đàn hồi E (kN/m²)</label>
                                    <input type="number" class="form-control" id="input-E" value="28000000" step="10000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-medium">Diện tích F (m²)</label>
                                    <input type="number" class="form-control" id="input-F" value="0.1225" step="0.001">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-medium">Quán tính I (m⁴)</label>
                                    <input type="number" class="form-control" id="input-Icoc" value="0.00125" step="0.0001">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-medium">Đường kính/Cạnh D (m)</label>
                                    <input type="number" class="form-control" id="input-D" value="0.35" step="0.05">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-medium">Chiều dài cọc L (m)</label>
                                    <input type="number" class="form-control" id="input-Lcoc" value="12.0" step="0.5">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-medium">Chiều dài tự do L0 (m)</label>
                                    <input type="number" class="form-control" id="input-L0" value="2.0" step="0.5">
                                </div>
                            </div>

                            <h5 class="mt-4"><i class="bi bi-square-fill"></i> Kích thước bệ (Cap Dimensions)</h5>
                            <hr>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Cạnh Bx (m)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="input-Bx" value="7" step="0.5">
                                        <span class="input-group-text bg-light">m</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Cạnh By (m)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="input-By" value="9" step="0.5">
                                        <span class="input-group-text bg-light">m</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="content-soil">
                            <h5>Điều kiện nền đất</h5>
                            <hr>
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <label class="form-label">Hệ số nền m (kN/m⁴)</label>
                                    <input type="number" class="form-control" id="input-m" value="6000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Hệ số nền chắn m_chan (kN/m⁴)</label>
                                    <input type="number" class="form-control" id="input-mchan" value="8000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Sức kháng mũi Rdat (kN/m²)</label>
                                    <input type="number" class="form-control" id="input-Rdat" value="6800">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Điều kiện mũi cọc</label>
                                    <select class="form-select" id="select-dieu-kien-mui">
                                        <option value="K" selected>Tựa lên đất (K)</option>
                                        <option value="T">Tựa lên đá (T)</option>
                                        <option value="N">Ngàm trong đá (N)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5>Các lớp đất (Tính Lnen)</h5>
                                <button class="btn btn-sm btn-success" id="add-soil-row-ui"><i class="bi bi-plus-lg"></i> Thêm lớp</button>
                            </div>
                            <div class="table-scroll-container">
                                <table class="table table-bordered table-hover mb-0" id="soil-layer-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="80" class="text-center">Lớp</th>
                                            <th>Chiều dày (m)</th>
                                            <th>Tdat (kN/m²)</th>
                                            <th>Góc ma sát (rad)</th>
                                            <th width="60" class="text-center"><i class="bi bi-gear"></i></th>
                                        </tr>
                                    </thead>
                                    <tbody id="soil-layer-body">
                                        </tbody>
                                </table>
                            </div>
                            <button id="add-soil-row" style="display:none;"></button> 
                        </div>

                        <div class="tab-pane fade" id="content-loads">
                            <h5><i class="bi bi-arrow-down-square-fill"></i> Tải trọng chân cột</h5>
                            <hr>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="bi bi-arrows-move"></i> Lực (Forces)</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Lực dọc Pz (kN)</label>
                                        <input type="number" class="form-control form-control-lg border-primary" id="input-Pz" value="12500">
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label">Hx (kN)</label>
                                            <input type="number" class="form-control" id="input-Hx" value="202">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Hy (kN)</label>
                                            <input type="number" class="form-control" id="input-Hy" value="720">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success"><i class="bi bi-arrow-repeat"></i> Mô men (Moments)</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Mô men xoắn Mz (kN.m)</label>
                                        <input type="number" class="form-control form-control-lg border-success" id="input-Mz" value="0">
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label">Mx (kN.m)</label>
                                            <input type="number" class="form-control" id="input-Mx" value="9344">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">My (kN.m)</label>
                                            <input type="number" class="form-control" id="input-My" value="3619">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="content-piles">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="bi bi-table"></i> Bảng tọa độ cọc 
                                    <span class="badge bg-primary rounded-pill ms-2" id="pile-count">0</span>
                                </h5>
                                <div class="btn-group">
                                    <label for="csv-file-input" class="btn btn-outline-success btn-sm">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> Nhập CSV
                                    </label>
                                    <input type="file" id="csv-file-input" accept=".csv, text/csv" style="display:none">
                                    
                                    <button class="btn btn-primary btn-sm" id="add-pile-row-ui">
                                        <i class="bi bi-plus-circle-fill"></i> Thêm cọc
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" id="remove-pile-row">
                                        <i class="bi bi-trash-fill"></i> Xóa cuối
                                    </button>
                                </div>
                            </div>

                            <div class="table-scroll-container">
                                <table class="table table-bordered table-striped table-hover mb-0" id="pile-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-center" width="60">ID</th>
                                            <th>X (m)</th>
                                            <th>Y (m)</th>
                                            <th>Góc nghiêng (rad)</th>
                                            <th>Góc xoay (rad)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pile-table-body">
                                        </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-link text-decoration-none p-0" id="load-sample-data">
                                    <i class="bi bi-magic"></i> Tải dữ liệu mẫu (24 cọc)
                                </button>
                                <button id="add-pile-row" style="display:none;"></button> </div>
                        </div>

                        <div class="tab-pane fade" id="content-license">
                            <div class="row">
                                <div class="col-md-8 mx-auto">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="bi bi-key-fill"></i> Kích hoạt PRO</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">Email đăng ký</label>
                                                <input type="email" class="form-control" id="user-email">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">License Key</label>
                                                <input type="text" class="form-control font-monospace" id="license-key">
                                            </div>
                                            <button class="btn btn-primary w-100" id="btn-check-license">Kiểm tra & Kích hoạt</button>
                                        </div>
                                    </div>
                                    <div id="license-status" class="alert alert-secondary mt-3 text-center">
                                        Trạng thái: Chưa kích hoạt (Tối đa 4 cọc)
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="card mt-4 shadow-sm" id="results-container" style="display:none"> <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 text-success">Kết quả phân tích</h4>
                    <div>
                        <button class="btn btn-sm btn-outline-success" id="save-csv-button"><i class="bi bi-file-earmark-excel"></i> CSV</button>
                        <button class="btn btn-sm btn-outline-danger" id="save-png-button"><i class="bi bi-card-image"></i> PNG</button>
                    </div>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" id="resultTabs">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#content-result-displacement">Chuyển vị</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-result-forces">Nội lực cọc</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-result-check">Kiểm toán</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-result-chart">Biểu đồ</button></li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="content-result-displacement">
                            <table class="table table-bordered table-striped">
                                <thead class="table-light"><tr><th>Hạng mục</th><th>Giá trị</th><th>Đơn vị</th></tr></thead>
                                <tbody id="displacement-results-body"></tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="content-result-forces">
                            <div class="table-scroll-container">
                                <table class="table table-bordered table-hover table-striped mb-0" id="forces-results-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Cọc số</th><th>N (kN)</th><th>QII (kN)</th><th>QIII (kN)</th>
                                            <th>MI (kN.m)</th><th>MII (kN.m)</th><th>MIII (kN.m)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="forces-results-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="content-result-check">
                            <h5>Kiểm toán móng khối quy ước</h5>
                            <table class="table table-bordered table-sm mb-4">
                                <tbody id="check-results-body"></tbody>
                            </table>
                            <h5>Cân bằng lực (Kiểm tra)</h5>
                            <table class="table table-bordered table-sm" id="balance-results-table">
                                <thead class="table-light"><tr><th>Lực</th><th>Tải (Nhập)</th><th>Phản lực (Tính)</th><th>Sai số (%)</th></tr></thead>
                                <tbody id="balance-results-body"></tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="content-result-chart">
                            <div style="height: 400px; width: 100%;">
                                <canvas id="pileForceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script src="../../assets/js/global.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Logic thêm lớp đất (Soil) ---
    const addSoilBtn = document.getElementById('add-soil-row-ui');
    if (addSoilBtn) {
        addSoilBtn.addEventListener('click', () => {
            const tbody = document.getElementById('soil-layer-body');
            const rowCount = tbody.rows.length + 1;
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td class="text-center fw-bold">${rowCount}</td>
                <td><input type="number" class="form-control" value="2.0" step="0.5"></td>
                <td><input type="number" class="form-control" value="0.0" step="10"></td>
                <td><input type="number" class="form-control" value="0.0" step="0.1"></td>
                <td class="text-center">
                    <button class="btn btn-outline-danger btn-sm border-0" onclick="AppUI.table.removeRow(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(newRow);
        });
    }

    // --- Logic thêm cọc (Pile) ---
    // Vì pilegroup.js có logic quản lý mảng cọc riêng, ta cần trigger sự kiện cho nút ẩn
    // hoặc sử dụng lại logic DOM manipulation tương tự
    const addPileBtn = document.getElementById('add-pile-row-ui');
    const oldAddBtn = document.getElementById('add-pile-row'); // Nút trong JS gốc
    
    if (addPileBtn && oldAddBtn) {
        addPileBtn.addEventListener('click', () => {
             // Cách 1: Trigger click vào nút cũ để tận dụng logic có sẵn trong pilegroup.js
             oldAddBtn.click();
        });
    }
});
</script>

<script src="pilegroup.js"></script> 
<script src="app-check.js"></script>
<script src="app-cal.js"></script>
<script src="app-out.js"></script>

</body>
</html>