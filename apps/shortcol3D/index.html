<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShortCol 3D - Phân tích Cột Lệch Tâm Xiên (Biaxial)</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="../../assets/css/global.css" />

    <style>
      /* Global Styles */
      body {
        background-color: #f8f9fa;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }

      /* Loading Overlay - Chuẩn hóa như shortcol2D */
      #loading-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        visibility: hidden;
        opacity: 0;
      }

      #loading-overlay.active {
        visibility: visible !important;
        opacity: 1 !important;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0d6efd;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        color: #0d6efd;
        font-weight: 600;
        margin-top: 1rem;
        font-size: 14px;
      }

      #svg-preview-container {
        background: #fff;
        border: 1px dashed #ced4da;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 250px;
        overflow: hidden;
      }

      .sidebar-card {
        background: #fff;
        border: 1px solid #dee2e6;
      }

      .table-scroll-container {
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay">
      <div class="spinner"></div>
      <div class="loading-text">
        <i class="bi bi-cpu"></i> Đang phân tích mặt cắt & tích phân sợi...
      </div>
    </div>

    <div id="root"></div>

    <script src="../../assets/js/global.js"></script>

    <!-- Load order: app-cal.js (Unified Engine) -> app-inp.js (UI input) -> app-out.js (display) -->
    <script src="app-cal.js"></script>
    <script src="app-inp.js" type="text/babel"></script>
    <script src="app-out.js" type="text/babel"></script>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // MainApp Component: Nơi kết nối logic và giao diện
      const MainApp = () => {
        const [inputData, setInputData] = useState(null);
        const [calcResults, setCalcResults] = useState(null);
        const [isComputing, setIsComputing] = useState(false);

        // Hàm xử lý khi người dùng nhấn "Tính toán" từ AppInp
        const handleCalculate = (data) => {
          // 1. Cập nhật state
          setInputData(data);
          setIsComputing(true);

          // 2. Bật Overlay (Thêm class active)
          const overlay = document.getElementById("loading-overlay");
          if (overlay) overlay.classList.add("active");

          // 3. Đẩy việc tính toán ra sau để UI kịp render Overlay
          setTimeout(() => {
            try {
              // Kiểm tra module tính toán
              if (typeof CalculationEngine === "undefined") {
                throw new Error(
                  "Chưa tải được module CalculationEngine. Vui lòng thử lại."
                );
              }

              // Gọi pure calculation function
              const results = CalculationEngine.performAnalysis(data);

              // Cập nhật kết quả
              setCalcResults(results);

              // Thông báo thành công
              if (typeof AppUI !== "undefined" && AppUI.toast) {
                AppUI.toast.show("Tính toán hoàn tất!", "success");
              }
            } catch (error) {
              console.error("Lỗi tính toán:", error);
              if (typeof AppUI !== "undefined" && AppUI.toast) {
                AppUI.toast.show("Lỗi: " + error.message, "danger");
              } else {
                alert("Đã xảy ra lỗi: " + error.message);
              }
            } finally {
              // 4. Tắt Overlay (Gỡ class active) và Reset trạng thái
              setIsComputing(false);
              if (overlay) overlay.classList.remove("active");
            }
          }, 100); // Delay 100ms
        };

        return (
          <div className="d-flex flex-column" style={{ minHeight: "100vh" }}>
            {/* Header */}
            <div
              className="bg-white border-bottom px-3 py-2 shadow-sm d-flex justify-content-between align-items-center sticky-top"
              style={{ zIndex: 40 }}
            >
              <div className="d-flex align-items-center gap-3">
                <div
                  style={{
                    width: "40px",
                    height: "40px",
                    backgroundColor: "#0d6efd",
                    borderRadius: "8px",
                  }}
                  className="d-flex align-items-center justify-content-center text-white"
                >
                  <i className="bi bi-box-seam fs-5"></i>
                </div>
                <div>
                  <h1 className="mb-0 fs-6 fw-bold text-dark">ShortCol 3D</h1>
                  <p className="mb-0 text-muted small">
                    Biểu độ tương tác 3D | P-Mx-My
                  </p>
                </div>
              </div>
              <div>
                <span className="badge bg-secondary">v2.1.0 Beta</span>
              </div>
            </div>

            {/* Main Layout Grid: 3 columns */}
            <div
              className="container-fluid flex-grow-1"
              style={{
                display: "grid",
                gridTemplateColumns: "300px 1fr 1fr",
                gridTemplateRows: "auto 1fr",
              }}
            >
              {/* LEFT SIDEBAR: SECTION & PREVIEW (Row 1-2, Col 1) */}
              <div
                className="border-end bg-light"
                style={{
                  overflowY: "auto",
                  maxHeight: "calc(100vh - 65px)",
                  gridColumn: "1",
                  gridRow: "1 / -1",
                }}
              >
                {/* Component Nhập liệu - Only Sidebar Content */}
                <AppInp
                  onCalculate={handleCalculate}
                  isComputing={isComputing}
                  sidebarOnly={true}
                />
              </div>

              {/* MIDDLE TOP: FORM INPUT (Row 1, Col 2-3) */}
              <div
                className="bg-white border-bottom"
                style={{
                  overflowY: "auto",
                  maxHeight: "40vh",
                  gridColumn: "2 / -1",
                  gridRow: "1",
                  borderRight: "1px solid #dee2e6",
                }}
              >
                {/* Component Nhập liệu - Form Content */}
                <AppInp
                  onCalculate={handleCalculate}
                  isComputing={isComputing}
                  formOnly={true}
                />
              </div>

              {/* MIDDLE BOTTOM: 3D CHART + RESULTS (Row 2, Col 2-3) */}
              <div
                className="bg-white"
                style={{
                  overflowY: "auto",
                  maxHeight: "calc(100vh - 65px - 40vh)",
                  gridColumn: "2 / -1",
                  gridRow: "2",
                  display: "flex",
                  flexDirection: "column",
                }}
              >
                {/* Component Kết quả */}
                <AppOut results={calcResults} input={inputData} />
              </div>
            </div>
          </div>
        );
      };

      // --- FIX: CƠ CHẾ POLLING CHỜ THƯ VIỆN ---
      // Hàm này sẽ đợi cho đến khi các biến toàn cục được load xong
      const mountApp = () => {
        if (
          window.AppInp &&
          window.AppOut &&
          window.CalculationEngine &&
          window.ShortCol3D
        ) {
          console.log("All modules loaded. Rendering App...");
          const root = ReactDOM.createRoot(document.getElementById("root"));
          root.render(<MainApp />);

          // Khởi tạo icon sau khi render
          setTimeout(() => {
            if (window.lucide) window.lucide.createIcons();
          }, 500);
        } else {
          console.log("Waiting for modules...");
          // Nếu chưa có, thử lại sau 50ms
          setTimeout(mountApp, 50);
        }
      };

      // Bắt đầu quy trình mount
      mountApp();
    </script>
  </body>
</html>
