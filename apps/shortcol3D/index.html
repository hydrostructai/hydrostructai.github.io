<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShortCol 3D - Phân tích Cột Lệch Tâm Xiên (Biaxial)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="../../assets/css/global.css">

    <style>
        /* Fallback Styles */
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --bg-body: #f8fafc;
        }
        body {
            background-color: var(--bg-body);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        /* FIX: Overlay mặt định ẩn để không che form */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            
            /* Quan trọng: Ẩn mặc định */
            visibility: hidden;
            opacity: 0;
        }

        /* Khi có class active thì mới hiện */
        #loading-overlay.active {
            visibility: visible !important;
            opacity: 1 !important;
        }

        .loading-text {
            color: var(--primary-color);
            font-weight: 600;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="loading-text">Đang phân tích mặt cắt & tích phân sợi...</div>
    </div>

    <div id="root"></div>

    <script src="../../assets/js/global.js"></script>

    <script src="shortcol3D.js"></script>
    <script src="app-cal.js" type="text/babel"></script>
    <script src="app-out.js" type="text/babel"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // MainApp Component: Nơi kết nối logic và giao diện
        const MainApp = () => {
            const [inputData, setInputData] = useState(null);
            const [calcResults, setCalcResults] = useState(null);
            const [isComputing, setIsComputing] = useState(false);

            // Hàm xử lý khi người dùng nhấn "Tính toán" từ AppCal
            const handleCalculate = (data) => {
                // 1. Cập nhật state
                setInputData(data);
                setIsComputing(true);

                // 2. Bật Overlay (Thêm class active)
                const overlay = document.getElementById('loading-overlay');
                if (overlay) overlay.classList.add('active');

                // 3. Đẩy việc tính toán ra sau để UI kịp render Overlay
                setTimeout(() => {
                    try {
                        // Kiểm tra module tính toán
                        if (typeof ShortCol3D === 'undefined') {
                            throw new Error("Chưa tải được module ShortCol3D. Vui lòng thử lại.");
                        }
                        
                        const engine = new ShortCol3D();
                        
                        // Thực hiện tính toán nặng
                        const results = engine.analyze(data);
                        
                        // Cập nhật kết quả
                        setCalcResults(results);

                        // Thông báo thành công
                        if (typeof AppUI !== 'undefined' && AppUI.toast) {
                            AppUI.toast.show("Tính toán hoàn tất!", "success");
                        }

                    } catch (error) {
                        console.error("Lỗi tính toán:", error);
                        if (typeof AppUI !== 'undefined' && AppUI.toast) {
                            AppUI.toast.show("Lỗi: " + error.message, "danger");
                        } else {
                            alert("Đã xảy ra lỗi: " + error.message);
                        }
                    } finally {
                        // 4. Tắt Overlay (Gỡ class active) và Reset trạng thái
                        setIsComputing(false);
                        if (overlay) overlay.classList.remove('active');
                    }
                }, 100); // Delay 100ms
            };

            return (
                <div className="flex flex-col min-h-screen">
                    {/* Header */}
                    <div className="bg-white border-b px-6 py-3 shadow-sm flex justify-between items-center sticky top-0 z-40">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-blue-200 shadow-lg">
                                <i className="bi bi-box-seam text-xl"></i>
                            </div>
                            <div>
                                <h1 className="text-lg font-bold text-slate-800 leading-tight">ShortCol 3D Pro</h1>
                                <p className="text-xs text-slate-500 font-medium">Phân tích tương tác không gian | P-Mx-My</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                             <span className="px-3 py-1 rounded-full bg-slate-100 text-slate-600 text-xs font-bold border border-slate-200">
                                v2.1.0 Beta
                            </span>
                        </div>
                    </div>

                    {/* Main Layout Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-12 flex-1">
                        
                        {/* LEFT SIDEBAR: INPUT (4 cols) */}
                        <div className="lg:col-span-4 xl:col-span-3 border-r bg-slate-50/50 flex flex-col h-full overflow-y-auto" style={{maxHeight: 'calc(100vh - 65px)'}}>
                            {/* Component Nhập liệu */}
                            <AppCal onCalculate={handleCalculate} isComputing={isComputing} />
                        </div>

                        {/* RIGHT CONTENT: OUTPUT (8 cols) */}
                        <div className="lg:col-span-8 xl:col-span-9 bg-white h-full overflow-y-auto" style={{maxHeight: 'calc(100vh - 65px)'}}>
                            {/* Component Kết quả */}
                            <AppOut results={calcResults} input={inputData} />
                        </div>
                    </div>
                </div>
            );
        };

        // --- FIX: CƠ CHẾ POLLING CHỜ THƯ VIỆN ---
        // Hàm này sẽ đợi cho đến khi các biến toàn cục (AppCal, AppOut) được load xong
        const mountApp = () => {
            if (window.AppCal && window.AppOut && window.ShortCol3D) {
                console.log("All modules loaded. Rendering App...");
                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<MainApp />);
                
                // Khởi tạo icon sau khi render
                setTimeout(() => {
                    if(window.lucide) window.lucide.createIcons();
                }, 500);
            } else {
                console.log("Waiting for modules...");
                // Nếu chưa có, thử lại sau 50ms
                setTimeout(mountApp, 50);
            }
        };

        // Bắt đầu quy trình mount
        mountApp();

    </script>
</body>
</html>