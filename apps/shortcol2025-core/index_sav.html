<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShortCol - Tính toán Cột Lệch Tâm</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #6b7280; }
        .tab-inactive:hover { color: #374151; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- HÀM TIỆN ÍCH TÍNH TOÁN & LOGIC TỪ VB6 ---

        // Logic chuyển đổi từ RectBarLayoutForm.frm (CommandButtonApply1_Click - Equal Spacing)
        const generateRectLayoutEqual = (B, H, Cover, Nb, As) => {
            const width = B - 2 * Cover;
            const height = H - 2 * Cover;
            
            if (Nb < 4) Nb = 4;
            if (Nb % 2 !== 0) Nb += 1; // Ensure even number

            // Logic VB6 tính số thanh mỗi cạnh để khoảng cách tương đối đều nhau
            let Nb1 = Math.floor(((width) * (Nb + 2) + 2 * (height)) / 2 / (H + B - 4 * Cover));
            if (Nb1 < 2) Nb1 = 2;
            
            // Điều chỉnh để tổng số thanh khớp với Nb
            let Nbot = Nb1;
            let Ntop = Nb1;
            let Nside = (Nb - Nbot - Ntop) / 2 + 2; 

            // Fallback nếu tính toán ra số lẻ hoặc không hợp lý
            if (!Number.isInteger(Nside)) {
                 Nside = Math.floor(Nb / 4) + 1;
                 Nbot = Math.floor((Nb - 2 * (Nside - 2)) / 2);
                 Ntop = Nb - Nbot - 2 * (Nside - 2);
            }

            const bars = [];
            
            // Top & Bot bars
            for (let i = 0; i < Nbot; i++) {
                bars.push({
                    x: -width/2 + (width / (Nbot - 1)) * i,
                    y: -height/2, // Bottom is negative in local coords
                    As: As
                });
            }
            for (let i = 0; i < Ntop; i++) {
                bars.push({
                    x: -width/2 + (width / (Ntop - 1)) * i,
                    y: height/2,
                    As: As
                });
            }
            
            // Side bars (excluding corners which are already added)
            const sideSpacing = height / (Nside - 1);
            for (let i = 1; i < Nside - 1; i++) {
                // Left side
                bars.push({
                    x: -width/2,
                    y: -height/2 + sideSpacing * i,
                    As: As
                });
                // Right side
                bars.push({
                    x: width/2,
                    y: -height/2 + sideSpacing * i,
                    As: As
                });
            }
            return bars;
        };

        // Logic chuyển đổi từ CircBarLayoutForm.frm (CommandButtonApply3_Click)
        const generateCircLayout = (D, Cover, Nb, As) => {
            const R_col = D / 2;
            const R_bars = R_col - Cover;
            const bars = [];
            
            if (Nb < 4) Nb = 4;
            const alpha = (2 * Math.PI) / Nb;

            for (let i = 0; i < Nb; i++) {
                // VB6: x = R * Cos(alpha * (k - 1)), y = R * Sin(...)
                // Xoay góc để thanh đầu tiên nằm ở đỉnh hoặc vị trí mong muốn (VB6 bắt đầu từ góc 0 - bên phải)
                const angle = alpha * i;
                bars.push({
                    x: R_bars * Math.cos(angle),
                    y: R_bars * Math.sin(angle),
                    As: As
                });
            }
            return bars;
        };

        // --- LOGIC TÍNH BIỂU ĐỒ TƯƠNG TÁC (SIMPLIFIED P-M INTERACTION) ---
        // Sử dụng phương pháp chia dải (Fiber Method) đơn giản hóa hoặc Khối ứng suất chữ nhật Whitney
        
        const calculateInteractionPoints = (type, B, H, D, fck, fyk, bars) => {
            const points = [];
            const Es = 200000; // MPa
            const e_cu = 0.003; // Bê tông nén cực hạn
            
            // Chuyển đổi fck (cấp độ bền) sang cường độ tính toán (giả định TCVN)
            // Ví dụ B20 -> Rb = 11.5, ở đây ta dùng giá trị nhập vào là Rb trực tiếp hoặc quy đổi
            const Rb = fck; 
            const Rs = fyk; 

            // Tập hợp các chiều sâu vùng nén c chạy từ -D đến 2D
            const steps = 40;
            const sectionDepth = type === 'rect' ? H : D;
            const c_values = [];
            
            // Pure Tension (c rất nhỏ âm)
            c_values.push(-9999);
            // Các điểm trung gian
            for(let i=0.05; i<=1.5; i+=1.5/steps) {
                c_values.push(i * sectionDepth);
            }
            // Pure Compression (c rất lớn)
            c_values.push(9999);

            c_values.forEach(c => {
                let Nu = 0; // Lực dọc (kN)
                let Mu = 0; // Mô men (kNm)

                // 1. Tính lực trong bê tông (Dùng khối ứng suất tương đương Whitney)
                // Chiều cao vùng nén hiệu quả a = beta1 * c
                const beta1 = 0.8; // Giả định đơn giản
                let a = beta1 * c;
                if (a > sectionDepth) a = sectionDepth;
                if (c < 0) a = 0;

                let Fc = 0;
                let Mc = 0;

                if (type === 'rect') {
                    if (c > 0) {
                        const Ac = B * a;
                        Fc = Rb * Ac; // N
                        // Tâm vùng nén cách trọng tâm tiết diện: H/2 - a/2
                        const leverArm = (H / 2) - (a / 2);
                        Mc = Fc * leverArm; // Nmm
                    }
                } else {
                    // Cột tròn: Diện tích chỏm cầu (Circular segment)
                    if (c > 0 && a > 0) {
                        // Tính diện tích phần chỏm bị cắt bởi a
                        // Góc ở tâm theta
                        // Khoảng cách từ tâm đến mép cắt: dist = R - a
                        const R = D/2;
                        let dist = R - a;
                        // Clamping dist
                        if (dist < -R) dist = -R; 
                        if (dist > R) dist = R;

                        // Diện tích phân tố nén
                        // Công thức diện tích chỏm cầu phức tạp, dùng tích phân số đơn giản cho nhanh
                        // Chia a thành các dải nhỏ
                        const numStrips = 20;
                        const dy = a / numStrips;
                        let Ac_sum = 0;
                        let Mc_sum = 0;
                        const topY = R;
                        
                        for(let j=0; j<numStrips; j++) {
                            const y_strip = topY - (j + 0.5) * dy; // Tọa độ y của dải
                            if (y_strip < -R) continue;
                            
                            // Bề rộng tại y_strip: x = sqrt(R^2 - y^2) -> width = 2x
                            const width_strip = 2 * Math.sqrt(R*R - y_strip*y_strip);
                            const dA = width_strip * dy;
                            
                            Ac_sum += dA;
                            Mc_sum += dA * y_strip; // Momen lấy đối với tâm
                        }
                        Fc = Rb * Ac_sum;
                        Mc = Rb * Mc_sum; // Nmm
                    }
                }

                // 2. Tính lực trong cốt thép
                let Fs_total = 0;
                let Ms_total = 0;

                bars.forEach(bar => {
                    // Tính biến dạng
                    // y_bar so với trục trung hòa. Trục trung hòa cách mép trên một khoảng c.
                    // Tọa độ bar.y có gốc tại tâm hình học.
                    // Mép trên tại H/2 (Rect) hoặc D/2 (Circ).
                    const y_top = type === 'rect' ? H/2 : D/2;
                    const d_bar = y_top - bar.y; // Khoảng cách từ mép trên nén đến thanh cốt thép
                    
                    // Biến dạng tại vị trí thanh thép: e_s = e_cu * (c - d_bar) / c
                    let e_s = 0;
                    if (Math.abs(c) < 1e-5) e_s = -0.01; // Kéo vô cùng
                    else if (c > 9000) e_s = e_cu; // Nén thuần túy
                    else e_s = e_cu * (c - d_bar) / c;

                    // Ứng suất
                    let sigma_s = e_s * Es;
                    if (sigma_s > Rs) sigma_s = Rs;
                    if (sigma_s < -Rs) sigma_s = -Rs;

                    const Fs = sigma_s * bar.As; // N (+ nén, - kéo)
                    Fs_total += Fs;
                    Ms_total += Fs * bar.y; // Moment = Lực * cánh tay đòn tới tâm (bar.y)
                });

                Nu = (Fc + Fs_total) / 1000; // kN
                Mu = (Mc + Ms_total) / 1000000; // kNm

                points.push({ x: Mu, y: Nu });
            });
            
            // Lọc bỏ các điểm lỗi hoặc sắp xếp lại nếu cần
            return points;
        };


        // --- COMPONENT CHÍNH ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('input');
            const [colType, setColType] = useState('rect'); // 'rect' | 'circ'
            
            // State: Vật liệu
            const [material, setMaterial] = useState({
                fck: 14.5, // Rb (MPa) - B20
                fyk: 280,  // Rs (MPa) - CB300-V
            });

            // State: Hình học
            const [geometry, setGeometry] = useState({
                B: 300, H: 400, D: 400,
                Cover: 30
            });

            // State: Cốt thép
            const [reinforcement, setReinforcement] = useState({
                Nb: 6,      // Tổng số thanh
                d_bar: 18,  // Đường kính
                As_bar: 254 // Diện tích 1 thanh (mm2) -> d18 ~ 254.5
            });

            // State: Tải trọng
            const [loads, setLoads] = useState([
                { id: 1, Pu: 500, Mu: 50, note: "TH1: Tĩnh + Hoạt" },
                { id: 2, Pu: 800, Mu: 120, note: "TH2: Gió trái" }
            ]);

            // Calculated Data
            const [barLayout, setBarLayout] = useState([]);
            const [interactionCurve, setInteractionCurve] = useState([]);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Cập nhật bố trí thép khi input thay đổi
            useEffect(() => {
                let bars = [];
                const As = reinforcement.As_bar;
                
                if (colType === 'rect') {
                    bars = generateRectLayoutEqual(geometry.B, geometry.H, geometry.Cover, reinforcement.Nb, As);
                } else {
                    bars = generateCircLayout(geometry.D, geometry.Cover, reinforcement.Nb, As);
                }
                setBarLayout(bars);
            }, [colType, geometry, reinforcement]);

            // Tính toán biểu đồ tương tác khi bố trí thép hoặc vật liệu thay đổi
            useEffect(() => {
                if (barLayout.length === 0) return;
                
                const curve = calculateInteractionPoints(
                    colType, 
                    geometry.B, geometry.H, geometry.D, 
                    material.fck, material.fyk, 
                    barLayout
                );
                setInteractionCurve(curve);
            }, [barLayout, material]);

            // Vẽ biểu đồ Chart.js
            useEffect(() => {
                if (!chartRef.current || interactionCurve.length === 0) return;

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                // Chuẩn bị dữ liệu tải trọng cho biểu đồ
                const loadPoints = loads.map(l => ({ x: l.Mu, y: l.Pu, label: l.note }));
                
                // Dữ liệu đường bao (Curve)
                // Cần 2 nhánh: M dương và M âm (đối xứng nếu tiết diện đối xứng)
                // ShortCol thường vẽ 1 bên dương. Ta lấy trị tuyệt đối M để vẽ "cánh buồm".
                const curveData = interactionCurve.map(p => ({ x: p.x, y: p.y })); // Giữ nguyên dấu để vẽ trọn vẹn hoặc abs nếu muốn

                // Đường gióng (Safety Lines): Nối từ (0,0) qua điểm tải trọng
                const datasets = [
                    {
                        label: 'Biểu đồ tương tác (Pu-Mu)',
                        data: curveData,
                        borderColor: 'rgb(37, 99, 235)',
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                        showLine: true,
                        pointRadius: 0,
                        fill: false,
                        tension: 0.1,
                        order: 2
                    },
                    {
                        label: 'Tổ hợp tải trọng',
                        data: loadPoints,
                        backgroundColor: 'rgb(220, 38, 38)',
                        borderColor: 'rgb(220, 38, 38)',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        type: 'scatter',
                        order: 1
                    }
                ];

                // Thêm các đường gióng cho từng điểm tải
                loads.forEach((load, idx) => {
                    datasets.push({
                        label: `Gióng ${load.id}`,
                        data: [{x: 0, y: 0}, {x: load.Mu, y: load.Pu}, {x: load.Mu * 1.5, y: load.Pu * 1.5}], // Vẽ dài ra chút
                        borderColor: 'rgba(156, 163, 175, 0.5)',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        pointRadius: 0,
                        showLine: true,
                        type: 'scatter',
                        order: 3,
                        hiddenLegend: true
                    });
                });

                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'scatter',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Biểu đồ tương tác Pu - Mu' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        if (context.dataset.label === 'Tổ hợp tải trọng') {
                                            const l = loads[context.dataIndex];
                                            return `${l.note}: M=${l.Mu}, P=${l.Pu}`;
                                        }
                                        return `(${context.raw.x.toFixed(1)}, ${context.raw.y.toFixed(1)})`;
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    filter: item => !item.text.includes('Gióng')
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Moment uốn Mu (kNm)' },
                                beginAtZero: true
                            },
                            y: {
                                title: { display: true, text: 'Lực dọc Pu (kN)' },
                                beginAtZero: true // Có thể bỏ nếu có lực kéo
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) chartInstance.current.destroy();
                };
            }, [interactionCurve, loads]);

            // Tính hệ số an toàn cho bảng
            const calculateSafetyFactor = (Pu, Mu) => {
                if (interactionCurve.length < 2) return 0;
                
                // Khoảng cách từ gốc
                const distLoad = Math.sqrt(Pu*Pu + Mu*Mu);
                if (distLoad === 0) return 999;

                // Tìm giao điểm của tia (0,0)->(Mu, Pu) với đường cong
                // Đơn giản hóa: Tìm điểm trên curve có tỷ lệ Mu/Pu gần nhất hoặc nội suy
                // Cách đơn giản nhất: So sánh bán kính cực (Polar radius) tại cùng góc theta
                const thetaLoad = Math.atan2(Pu, Mu); // (-PI to PI)
                
                // Tìm đoạn thẳng trên curve chứa tia này
                // Duyệt qua các đoạn thẳng của curve
                let maxDistCurve = 0;
                
                for(let i=0; i<interactionCurve.length-1; i++) {
                    const p1 = interactionCurve[i];
                    const p2 = interactionCurve[i+1];
                    
                    // Kiểm tra giao cắt vector
                    // Đây là bài toán hình học phức tạp, ta dùng cách xấp xỉ đơn giản:
                    // So sánh lực dọc khả năng tại cùng độ lệch tâm e = M/P
                    // Hoặc xấp xỉ bằng khoảng cách
                }

                // Cách tiếp cận thực dụng cho Web App đơn giản:
                // Tìm điểm trên curve gần với đường gióng nhất, lấy tỷ lệ
                // Hệ số k = Length_Capacity / Length_Load
                // Ta dùng thuật toán Ray Casting đơn giản
                
                // 1. Define Line from (0,0) to (Mu*100, Pu*100)
                // 2. Intersect with Curve segments
                // Simplified: Tìm điểm có Momen xấp xỉ Mu và so sánh Pu (nếu e nhỏ) hoặc ngược lại
                
                // Logic chính xác:
                const e = Mu / (Pu === 0 ? 0.001 : Pu);
                // Tìm P trên biểu đồ ứng với e này
                // Interpolate P_cap from Curve where x/y = e
                
                let P_cap = 0;
                let M_cap = 0;
                
                // Quét curve để tìm giao điểm
                for(let i=0; i<interactionCurve.length-1; i++) {
                    const p1 = interactionCurve[i];
                    const p2 = interactionCurve[i+1];
                    
                    // Bỏ qua nhánh kéo quá lớn hoặc không hợp lý
                    if (p1.y < 0 && p2.y < 0) continue; 

                    // Check intersection of Segment(p1, p2) and Ray((0,0), (Mu, Pu))
                    // Dùng công thức vector cross product
                    // v1 = p1, v2 = p2, v3 = (Mu, Pu)
                    // ... (Đơn giản hơn: Tìm điểm cắt đường thẳng y = (1/e)x)
                    
                    // Nếu Mu ~ 0 (nén đúng tâm), lấy P max
                    if (Math.abs(Mu) < 1) {
                         if (p1.x < 5 && p1.y > P_cap) P_cap = p1.y;
                         continue;
                    }

                    // Kiểm tra nếu tia nằm giữa p1 và p2 theo góc
                    const ang1 = Math.atan2(p1.y, p1.x);
                    const ang2 = Math.atan2(p2.y, p2.x);
                    const angLoad = Math.atan2(Pu, Mu);
                    
                    // Cần xử lý góc cẩn thận, nhưng ở phần dương I (P>0, M>0) thì dễ
                    if ((angLoad - ang1) * (angLoad - ang2) <= 0) {
                        // Giao điểm
                        // Giải hệ pt tuyến tính tìm k_scale
                        // P_cap = k * Pu, M_cap = k * Mu
                        // P_cap = p1.y + t*(p2.y - p1.y)
                        // M_cap = p1.x + t*(p2.x - p1.x)
                        
                        // k*Pu = y1 + t(dy)
                        // k*Mu = x1 + t(dx)
                        // => k = (x1*dy - y1*dx) / (Mu*dy - Pu*dx)
                        
                        const dx = p2.x - p1.x;
                        const dy = p2.y - p1.y;
                        const det = Mu*dy - Pu*dx;
                        if (Math.abs(det) > 1e-5) {
                            const k = (p1.x*dy - p1.y*dx) / det;
                            if (k > 0) {
                                P_cap = k * Pu;
                                M_cap = k * Mu;
                                break; // Found intersection
                            }
                        }
                    }
                }
                
                if (P_cap !== 0) {
                    const k = Math.sqrt(P_cap**2 + M_cap**2) / distLoad;
                    return k.toFixed(2);
                }
                return "N/A";
            };

            const handleLoadChange = (id, field, value) => {
                const newLoads = loads.map(l => l.id === id ? { ...l, [field]: value } : l);
                setLoads(newLoads);
            };

            const addLoad = () => {
                setLoads([...loads, { id: Date.now(), Pu: 0, Mu: 0, note: "Tải trọng mới" }]);
            };

            const removeLoad = (id) => {
                setLoads(loads.filter(l => l.id !== id));
            };

            // --- RENDER HELPERS ---

            const renderCrossSection = () => {
                const scale = 200 / Math.max(geometry.B || geometry.D, geometry.H || geometry.D);
                const cx = 150;
                const cy = 150;
                
                return (
                    <svg width="300" height="300" className="border bg-white shadow-sm mx-auto">
                        <g transform={`translate(${cx}, ${cy}) scale(${scale})`}>
                            {/* Concrete Section */}
                            {colType === 'rect' ? (
                                <rect 
                                    x={-geometry.B/2} y={-geometry.H/2} 
                                    width={geometry.B} height={geometry.H} 
                                    fill="#e5e7eb" stroke="#374151" strokeWidth="2" 
                                />
                            ) : (
                                <circle 
                                    cx="0" cy="0" r={geometry.D/2} 
                                    fill="#e5e7eb" stroke="#374151" strokeWidth="2"
                                />
                            )}
                            
                            {/* Rebars */}
                            {barLayout.map((bar, idx) => (
                                <circle 
                                    key={idx}
                                    cx={bar.x} cy={-bar.y} // SVG y is down, coords y is up
                                    r={reinforcement.d_bar/2}
                                    fill="#dc2626"
                                />
                            ))}

                            {/* Dimensions Label - Simple */}
                            <line x1={-150/scale} y1="0" x2={150/scale} y2="0" stroke="#9ca3af" strokeWidth="1" strokeDasharray="4" />
                            <line x1="0" y1={-150/scale} x2="0" y2={150/scale} stroke="#9ca3af" strokeWidth="1" strokeDasharray="4" />
                        </g>
                        <text x="10" y="290" className="text-xs text-gray-500">Scale: 1px = {(1/scale).toFixed(2)}mm</text>
                    </svg>
                );
            };

            return (
                <div className="min-h-screen p-4 max-w-7xl mx-auto">
                    {/* Header */}
                    <div className="bg-white p-4 rounded-lg shadow mb-4 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-600 p-2 rounded text-white">
                                <i data-lucide="layout-grid"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-gray-800">ShortCol Web App</h1>
                                <p className="text-sm text-gray-500">Tính toán cột chịu nén lệch tâm phẳng</p>
                            </div>
                        </div>
                        <div className="text-right text-sm text-gray-600">
                             Dựa trên logic Visual Basic 6.0<br/>
                             Design by HydroStructAI
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        {/* LEFT COLUMN: INPUTS */}
                        <div className="lg:col-span-5 flex flex-col gap-4">
                            
                            {/* TAB NAVIGATION */}
                            <div className="bg-white rounded-lg shadow overflow-hidden">
                                <div className="flex border-b">
                                    {['input', 'loads'].map(tab => (
                                        <button 
                                            key={tab}
                                            onClick={() => setActiveTab(tab)}
                                            className={`flex-1 py-3 text-sm font-medium ${activeTab === tab ? 'tab-active bg-blue-50' : 'tab-inactive bg-white'}`}
                                        >
                                            {tab === 'input' ? 'Thông số đầu vào' : 'Tải trọng & Kết quả'}
                                        </button>
                                    ))}
                                </div>

                                <div className="p-4">
                                    {activeTab === 'input' && (
                                        <div className="space-y-6">
                                            {/* Section 1: Loại cột */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Loại tiết diện</label>
                                                <div className="flex gap-4">
                                                    <label className={`flex items-center gap-2 border p-3 rounded cursor-pointer w-full ${colType==='rect' ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-gray-200'}`}>
                                                        <input type="radio" name="colType" value="rect" checked={colType==='rect'} onChange={() => setColType('rect')} className="accent-blue-600" />
                                                        <span>Chữ nhật (Rect)</span>
                                                    </label>
                                                    <label className={`flex items-center gap-2 border p-3 rounded cursor-pointer w-full ${colType==='circ' ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-gray-200'}`}>
                                                        <input type="radio" name="colType" value="circ" checked={colType==='circ'} onChange={() => setColType('circ')} className="accent-blue-600" />
                                                        <span>Tròn (Circ)</span>
                                                    </label>
                                                </div>
                                            </div>

                                            {/* Section 2: Kích thước */}
                                            <div className="bg-gray-50 p-4 rounded border">
                                                <h3 className="text-sm font-semibold text-gray-800 mb-3 uppercase">Kích thước hình học (mm)</h3>
                                                <div className="grid grid-cols-2 gap-4">
                                                    {colType === 'rect' ? (
                                                        <>
                                                            <div>
                                                                <label className="text-xs text-gray-500">Bề rộng (B)</label>
                                                                <input type="number" value={geometry.B} onChange={e => setGeometry({...geometry, B: +e.target.value})} className="w-full mt-1 border rounded p-2 focus:ring-blue-500 focus:border-blue-500" />
                                                            </div>
                                                            <div>
                                                                <label className="text-xs text-gray-500">Chiều cao (H)</label>
                                                                <input type="number" value={geometry.H} onChange={e => setGeometry({...geometry, H: +e.target.value})} className="w-full mt-1 border rounded p-2" />
                                                            </div>
                                                        </>
                                                    ) : (
                                                        <div>
                                                            <label className="text-xs text-gray-500">Đường kính (D)</label>
                                                            <input type="number" value={geometry.D} onChange={e => setGeometry({...geometry, D: +e.target.value})} className="w-full mt-1 border rounded p-2" />
                                                        </div>
                                                    )}
                                                    <div>
                                                        <label className="text-xs text-gray-500">Lớp bảo vệ (a)</label>
                                                        <input type="number" value={geometry.Cover} onChange={e => setGeometry({...geometry, Cover: +e.target.value})} className="w-full mt-1 border rounded p-2" />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Section 3: Vật liệu */}
                                            <div className="bg-gray-50 p-4 rounded border">
                                                <h3 className="text-sm font-semibold text-gray-800 mb-3 uppercase">Vật liệu (MPa)</h3>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="text-xs text-gray-500">Bê tông Rb (fck)</label>
                                                        <input type="number" value={material.fck} onChange={e => setMaterial({...material, fck: +e.target.value})} className="w-full mt-1 border rounded p-2" />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-gray-500">Cốt thép Rs (fyk)</label>
                                                        <input type="number" value={material.fyk} onChange={e => setMaterial({...material, fyk: +e.target.value})} className="w-full mt-1 border rounded p-2" />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Section 4: Cốt thép */}
                                            <div className="bg-gray-50 p-4 rounded border">
                                                <h3 className="text-sm font-semibold text-gray-800 mb-3 uppercase">Bố trí cốt thép</h3>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="text-xs text-gray-500">Tổng số thanh (Nb)</label>
                                                        <input type="number" value={reinforcement.Nb} onChange={e => setReinforcement({...reinforcement, Nb: +e.target.value})} className="w-full mt-1 border rounded p-2" />
                                                        <p className="text-[10px] text-gray-400 mt-1">Logic: Equal Spacing</p>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-gray-500">Diện tích 1 thanh (mm2)</label>
                                                        <input type="number" value={reinforcement.As_bar} onChange={e => setReinforcement({...reinforcement, As_bar: +e.target.value})} className="w-full mt-1 border rounded p-2" />
                                                        <p className="text-[10px] text-gray-400 mt-1">D18 ≈ 254.5, D20 ≈ 314</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'loads' && (
                                        <div className="space-y-4">
                                            <div className="flex justify-between items-center mb-2">
                                                <h3 className="text-sm font-semibold text-gray-800">Bảng tổ hợp nội lực</h3>
                                                <button onClick={addLoad} className="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">+ Thêm tổ hợp</button>
                                            </div>
                                            
                                            <div className="overflow-x-auto border rounded-lg">
                                                <table className="w-full text-sm text-left">
                                                    <thead className="bg-gray-100 text-gray-700 font-semibold">
                                                        <tr>
                                                            <th className="p-2 w-10">#</th>
                                                            <th className="p-2">Ghi chú</th>
                                                            <th className="p-2 w-20">Mu (kNm)</th>
                                                            <th className="p-2 w-20">Pu (kN)</th>
                                                            <th className="p-2 w-10"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y">
                                                        {loads.map((load, idx) => (
                                                            <tr key={load.id} className="hover:bg-gray-50">
                                                                <td className="p-2 text-center text-gray-500">{idx + 1}</td>
                                                                <td className="p-2">
                                                                    <input type="text" value={load.note} onChange={e => handleLoadChange(load.id, 'note', e.target.value)} className="w-full bg-transparent outline-none focus:underline" />
                                                                </td>
                                                                <td className="p-2">
                                                                    <input type="number" value={load.Mu} onChange={e => handleLoadChange(load.id, 'Mu', +e.target.value)} className="w-full border rounded px-1" />
                                                                </td>
                                                                <td className="p-2">
                                                                    <input type="number" value={load.Pu} onChange={e => handleLoadChange(load.id, 'Pu', +e.target.value)} className="w-full border rounded px-1" />
                                                                </td>
                                                                <td className="p-2 text-center">
                                                                    <button onClick={() => removeLoad(load.id)} className="text-red-500 hover:text-red-700 font-bold">&times;</button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <div className="mt-4 p-3 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-200">
                                                <span className="font-bold">Lưu ý:</span> Nhập Momen (Mu) và Lực dọc (Pu) tính toán. Ứng dụng sẽ tự động chấm điểm lên biểu đồ.
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                             {/* Preview Image (Canvas Area) */}
                             <div className="bg-white p-4 rounded-lg shadow flex flex-col items-center justify-center">
                                <h3 className="text-sm font-semibold text-gray-500 mb-2 w-full text-left">Tiết diện & Bố trí thép</h3>
                                {renderCrossSection()}
                                <div className="mt-2 text-sm text-gray-600">
                                    Hàm lượng cốt thép: <span className="font-bold text-blue-600">{((barLayout.length * reinforcement.As_bar) / (colType==='rect' ? geometry.B*geometry.H : Math.PI*Math.pow(geometry.D/2, 2)) * 100).toFixed(2)}%</span>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: CHART & RESULTS */}
                        <div className="lg:col-span-7 flex flex-col gap-6">
                            
                            {/* Chart Area */}
                            <div className="bg-white p-4 rounded-lg shadow h-[500px] flex flex-col">
                                <h3 className="text-sm font-semibold text-gray-800 mb-2">Biểu đồ tương tác (Interaction Diagram)</h3>
                                <div className="flex-1 relative w-full h-full">
                                    <canvas ref={chartRef}></canvas>
                                </div>
                            </div>

                            {/* Result Table */}
                            <div className="bg-white p-4 rounded-lg shadow">
                                <h3 className="text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                    <i data-lucide="table" className="w-4 h-4"></i>
                                    Kết quả kiểm tra khả năng chịu lực
                                </h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left border-collapse">
                                        <thead>
                                            <tr className="bg-gray-100 border-b border-gray-200">
                                                <th className="py-2 px-3">Tổ hợp</th>
                                                <th className="py-2 px-3 text-right">Mu (kNm)</th>
                                                <th className="py-2 px-3 text-right">Pu (kN)</th>
                                                <th className="py-2 px-3 text-right">M_cap (kNm)</th>
                                                <th className="py-2 px-3 text-right">P_cap (kN)</th>
                                                <th className="py-2 px-3 text-center">HS An toàn (k)</th>
                                                <th className="py-2 px-3 text-center">Đánh giá</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {loads.map((load) => {
                                                const k = parseFloat(calculateSafetyFactor(load.Pu, load.Mu));
                                                // Tính M_cap, P_cap tạm tính từ k
                                                const Mcap = (load.Mu * k).toFixed(1);
                                                const Pcap = (load.Pu * k).toFixed(1);
                                                const isSafe = k >= 1.0;

                                                return (
                                                    <tr key={load.id} className={isSafe ? "bg-white" : "bg-red-50"}>
                                                        <td className="py-2 px-3 font-medium text-gray-700">{load.note}</td>
                                                        <td className="py-2 px-3 text-right">{load.Mu}</td>
                                                        <td className="py-2 px-3 text-right">{load.Pu}</td>
                                                        <td className="py-2 px-3 text-right text-gray-500">{!isNaN(k) ? Mcap : '-'}</td>
                                                        <td className="py-2 px-3 text-right text-gray-500">{!isNaN(k) ? Pcap : '-'}</td>
                                                        <td className="py-2 px-3 text-center font-bold">
                                                            <span className={isSafe ? "text-green-600" : "text-red-600"}>
                                                                {isNaN(k) ? "Ngoài phạm vi" : k}
                                                            </span>
                                                        </td>
                                                        <td className="py-2 px-3 text-center">
                                                            {isNaN(k) ? <span className="text-gray-400">-</span> : (
                                                                isSafe 
                                                                ? <span className="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs border border-green-200">Đạt</span>
                                                                : <span className="bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs border border-red-200">Không đạt</span>
                                                            )}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Initialize Icons
        setTimeout(() => {
            if(window.lucide) lucide.createIcons();
        }, 500);
    </script>
</body>
</html>