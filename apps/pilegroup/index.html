<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bệ cọc đài cao (Pile Group 3D)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; }
        .card { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .nav-tabs .nav-link { color: #495057; }
        .nav-tabs .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-bottom-color: #0d6efd;
        }
        /* --- THÊM MỚI: Nền xanh nhẹ cho sidebar --- */
        .sidebar-card {
            background-color: #e6f7ff; /* Nền xanh nhạt */
        }
        /* Tùy chỉnh input trong bảng */
        #pile-table-body input, #soil-layer-body input {
            width: 100%;
            border: 1px solid #ddd;
            padding: 4px;
            border-radius: 4px;
        }
        #pile-table-body input:focus, #soil-layer-body input:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 2px rgba(13,110,253,.25);
        }
        /* Container kết quả (ẩn ban đầu) */
        #results-container { display: none; }
        /* Kiểu chữ cho kết quả kiểm toán */
        .status-success { color: #198754; font-weight: bold; }
        .status-fail { color: #dc3545; font-weight: bold; }
        /* Ẩn spinner */
        .spinner-border { display: none; }
        /* Ẩn input file gốc */
        #csv-file-input { display: none; }
        /* Bảng cuộn */
        .table-scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .table-scroll-container thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <div class="row">
            <div class="col-lg-3 mb-4">
                <div class="card p-3 sticky-top sidebar-card" style="top: 1rem;">
                    <h4><i class="bi bi-rocket-takeoff-fill text-primary"></i> Điều khiển</h4>
                    <hr>
                    <button class="btn btn-lg btn-success w-100" id="calculate-button" disabled>
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="calc-spinner"></span>
                        <i class="bi bi-calculator"></i> Run Analysis
                    </button>
                    
                    <div class="alert alert-info mt-3" id="wasm-status">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-primary me-2" role="status" id="wasm-spinner"></div>
                            <span id="wasm-status-text">Đang tải lõi tính toán (Wasm)...</span>
                        </div>
                    </div>
                    <div class="alert alert-danger mt-3" id="error-message" style="display: none;"></div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">Bệ cọc đài cao 3D (Zavriev-Spiro)</h3>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="inputTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tab-material" data-bs-toggle="tab" data-bs-target="#content-material" type="button">1. Vật liệu</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-soil" data-bs-toggle="tab" data-bs-target="#content-soil" type="button">2. Đất nền</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-loads" data-bs-toggle="tab" data-bs-target="#content-loads" type="button">3. Tải trọng</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-piles" data-bs-toggle="tab" data-bs-target="#content-piles" type="button">4. Bố trí cọc</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-license" data-bs-toggle="tab" data-bs-target="#content-license" type="button"><i class="bi bi-patch-check"></i> 5. Bản quyền</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content p-3 border border-top-0" id="inputTabsContent">
                            
                            <div class="tab-pane fade show active" id="content-material" role="tabpanel">
                                <h5>Thông số Cọc</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">E (T/m2)</label>
                                        <input type="number" class="form-control" id="input-E" value="2800000">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">F (m2)</label>
                                        <input type="number" class="form-control" id="input-F" value="0.1225">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Icoc (m4)</label>
                                        <input type="number" class="form-control" id="input-Icoc" value="0.00125">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">D (m)</label>
                                        <input type="number" class="form-control" id="input-D" value="0.35">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Lcoc (m)</label>
                                        <input type="number" class="form-control" id="input-Lcoc" value="12.0">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">L0 (m)</label>
                                        <input type="number" class="form-control" id="input-L0" value="2.0">
                                    </div>
                                </div>
                                <h5 class="mt-4">Kích thước móng quy ước (Kiểm toán)</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Bx (m)</label>
                                        <input type="number" class="form-control" id="input-Bx" value="7">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">By (m)</label>
                                        <input type="number" class="form-control" id="input-By" value="9">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="content-soil" role="tabpanel">
                                <h5>Điều kiện nền</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">m (T/m4)</label>
                                        <input type="number" class="form-control" id="input-m" value="600">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">m_chan (T/m4)</label>
                                        <input type="number" class="form-control" id="input-mchan" value="800">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Rdat (T/m2)</label>
                                        <input type="number" class="form-control" id="input-Rdat" value="680">
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-4">
                                        <label class="form-label">Điều kiện mũi cọc</label>
                                        <select class="form-select" id="select-dieu-kien-mui">
                                            <option value="K" selected>Tựa lên đất (K)</option>
                                            <option value="T">Tựa lên đá (T)</option>
                                            <option value="N">Ngàm trong đá (N)</option>
                                        </select>
                                    </div>
                                </div>
                                <h5 class="mt-4">Các lớp đất (ảnh hưởng đến Lnen)</h5>
                                <div class="table-scroll-container">
                                    <table class="table table-sm table-bordered" id="soil-layer-table">
                                        <thead>
                                            <tr>
                                                <th>Lớp</th>
                                                <th>Ldat (m)</th>
                                                <th>Tdat (T/m2)</th>
                                                <th>Phi (rad)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="soil-layer-body">
                                            </tbody>
                                    </table>
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" id="add-soil-row"><i class="bi bi-plus-circle"></i> Thêm lớp đất</button>
                            </div>

                            <div class="tab-pane fade" id="content-loads" role="tabpanel">
                                <h5>Tải trọng tại đáy bệ (T, T.m)</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Hx (T)</label>
                                        <input type="number" class="form-control" id="input-Hx" value="20.2">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Hy (T)</label>
                                        <input type="number" class="form-control" id="input-Hy" value="72.0">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Pz (T)</label>
                                        <input type="number" class="form-control" id="input-Pz" value="1250.06">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Mx (T.m)</label>
                                        <input type="number" class="form-control" id="input-Mx" value="934.4">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">My (T.m)</label>
                                        <input type="number" class="form-control" id="input-My" value="361.9">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Mz (T.m)</label>
                                        <input type="number" class="form-control" id="input-Mz" value="0.0">
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="content-piles" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">Bảng bố trí cọc (<span id="pile-count">0</span> cọc)</h5>
                                    <div>
                                        <label for="csv-file-input" class="btn btn-sm btn-success">
                                            <i class="bi bi-file-earmark-spreadsheet"></i> Nhập CSV
                                        </label>
                                        <input type="file" id="csv-file-input" accept=".csv, text/csv">
                                        <button class="btn btn-sm btn-outline-primary" id="add-pile-row"><i class="bi bi-plus-circle"></i> Thêm</button>
                                        <button class="btn btn-sm btn-outline-danger" id="remove-pile-row"><i class="bi bi-trash"></i> Xóa</button>
                                    </div>
                                </div>
                                <div class="table-scroll-container">
                                    <table class="table table-sm table-bordered table-striped" id="pile-table">
                                        <thead>
                                            <tr>
                                                <th>STT</th>
                                                <th>X (m)</th>
                                                <th>Y (m)</th>
                                                <th>Góc Fi (rad)</th>
                                                <th>Góc Psi (rad)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pile-table-body">
                                            </tbody>
                                    </table>
                                </div>
                                <button class="btn btn-sm btn-info mt-2" id="load-sample-data">
                                    <i class="bi bi-clipboard-data"></i> Tải dữ liệu mẫu (24 cọc)
                                </button>
                            </div>
                            
                            <div class="tab-pane fade" id="content-license" role="tabpanel">
                                <h5>Quản lý bản quyền</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-2">
                                            <label for="user-email" class="form-label">Email đăng ký:</label>
                                            <input type="email" class="form-control" id="user-email" placeholder="Nhập email của bạn">
                                        </div>
                                        <div class="form-group mb-2">
                                            <label for="license-key" class="form-label">License Key:</label>
                                            <input type="text" class="form-control" id="license-key" placeholder="Nhập license key">
                                        </div>
                                        <button class="btn btn-primary" id="btn-check-license">
                                            <i class="bi bi-patch-check"></i> Kiểm tra
                                        </button>
                                        <div id="license-status" class="mt-3 alert alert-secondary">
                                            Trạng thái: Chưa kích hoạt. Giới hạn 10 cọc.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>

                <div class="card mt-4" id="results-container">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Kết quả Phân tích</h3>
                        <div>
                            <button class="btn btn-sm btn-outline-success" id="save-csv-button"><i class="bi bi-file-earmark-ruled"></i> Xuất CSV</button>
                            <button class="btn btn-sm btn-outline-danger" id="save-png-button"><i class="bi bi-image"></i> Xuất PNG</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tab-result-displacement" data-bs-toggle="tab" data-bs-target="#content-result-displacement" type="button">Chuyển vị bệ</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-result-forces" data-bs-toggle="tab" data-bs-target="#content-result-forces" type="button">Nội lực cọc</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-result-check" data-bs-toggle="tab" data-bs-target="#content-result-check" type="button">Kiểm toán</button>
                            </li>
                             <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-result-chart" data-bs-toggle="tab" data-bs-target="#content-result-chart" type="button">Biểu đồ</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content p-3 border border-top-0" id="resultTabsContent">
                            <div class="tab-pane fade show active" id="content-result-displacement" role="tabpanel">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Hạng mục</th>
                                            <th>Giá trị</th>
                                            <th>Đơn vị</th>
                                        </tr>
                                    </thead>
                                    <tbody id="displacement-results-body">
                                    </tbody>
                                </table>
                            </div>
                            <div class="tab-pane fade" id="content-result-forces" role="tabpanel">
                                <div class="table-scroll-container">
                                    <table class="table table-sm table-bordered table-striped" id="forces-results-table">
                                        <thead>
                                            <tr>
                                                <th>Cọc số</th>
                                                <th>N (T)</th>
                                                <th>QII (T)</th>
                                                <th>QIII (T)</th>
                                                <th>MI (T.m)</th>
                                                <th>MII (T.m)</th>
                                                <th>MIII (T.m)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="forces-results-body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="content-result-check" role="tabpanel">
                                <h5>Kiểm toán móng khối quy ước (Spiro)</h5>
                                <table class="table table-sm table-bordered">
                                    <tbody id="check-results-body">
                                    </tbody>
                                </table>
                                <h5 class="mt-4">Kiểm tra cân bằng lực</h5>
                                <table class="table table-sm table-bordered" id="balance-results-table">
                                    <thead>
                                        <tr>
                                            <th>Lực</th>
                                            <th>Tải trọng (Nhập)</th>
                                            <th>Phản lực (Tính)</th>
                                            <th>Chênh lệch (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="balance-results-body">
                                    </tbody>
                                </table>
                            </div>
                            <div class="tab-pane fade" id="content-result-chart" role="tabpanel">
                                <canvas id="pileForceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <script src="pilegroup.js"></script> 
    <script src="app-check.js"></script>
    <script src="app-cal.js"></script>
    <script src="app-out.js"></script>
</body>
</html>