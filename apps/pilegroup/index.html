<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pile Group Analysis (Bệ cọc)</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .wrapper { display: flex; width: 100%; align-items: stretch; }

        /* --- Cấu hình Sidebar --- */
        #sidebar {
            min-width: 280px;
            max-width: 280px;
            background: #343a40; color: #fff;
            transition: all 0.3s;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        #sidebar .sidebar-header {
            padding: 20px; background: #212529; text-align: center;
            flex-shrink: 0;
        }
        #sidebar ul.components {
            padding: 20px 0;
            border-bottom: 1px solid #474747;
            overflow-y: auto; 
        }
        #sidebar ul li a {
            padding: 10px 20px; font-size: 1.1em; display: block;
            color: #adb5bd; text-decoration: none; transition: all 0.3s;
        }
        #sidebar ul li a:hover { color: #ffffff; background: #495057; }
        #sidebar ul li.active > a, a[aria-expanded="true"] { color: #fff; background: #007bff; }
        #sidebar .sidebar-controls {
            padding: 15px 20px 0 20px; flex-shrink: 0;
        }
        #sidebar .sidebar-footer {
            padding: 20px; flex-shrink: 0; margin-top: auto; 
        }

        /* --- Cấu hình Content --- */
        #content {
            width: 100%; padding: 20px; min-height: 100vh;
            transition: all 0.3s; margin-left: 280px; 
        }
        #content > .content-section { display: none; }
        #content > .content-section.active { display: block; }
        .table-responsive { display: block; width: 100%; overflow-x: auto; }
        
        /* Style cho kết quả */
        #noi_luc_coc_table table { font-size: 0.85rem; }
        #noi_luc_coc_table th, #noi_luc_coc_table td { padding: 0.25rem 0.5rem; }
        
        #pile-cap-canvas {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            background-color: #fff;
        }
        .status-success { color: green; font-weight: bold; }
        .status-fail { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="wrapper">
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3>Pile Group (Bệ cọc)</h3>
            <strong>PG</strong>
        </div>

        <ul class="list-unstyled components">
            <li class="active">
                <a href="#" class="sidebar-link" data-target="div_vat_lieu">
                    <i class="fas fa-ruler-combined"></i> Vật liệu & Cọc
                </a>
            </li>
            <li>
                <a href="#" class="sidebar-link" data-target="div_dat_nen">
                    <i class="fas fa-layer-group"></i> Thông số Đất nền
                </a>
            </li>
            <li>
                <a href="#" class="sidebar-link" data-target="div_be_coc">
                    <i class="fas fa-cube"></i> Kích thước Bệ
                </a>
            </li>
            <li>
                <a href="#" class="sidebar-link" data-target="div_coc">
                    <i class="fas fa-th"></i> Vị trí Cọc
                </a>
            </li>
            <li>
                <a href="#" class="sidebar-link" data-target="div_tai_trong">
                    <i class="fas fa-truck-loading"></i> Tải trọng tại Đài
                </a>
            </li>
            <li>
                <a href="#" class="sidebar-link" data-target="div_license">
                    <i class="fas fa-id-card"></i> Bản quyền
                </a>
            </li>
        </ul>

        <div class="sidebar-controls">
            <button class="btn btn-primary btn-block" id="btn-check-license-sidebar">
                <i class="fas fa-check-circle"></i> Check License
            </button>
            <button class="btn btn-info btn-block mt-2" id="btn-export-report" disabled>
                <i class="fas fa-file-export"></i> Export CSV
            </button>
        </div>
        
        <div class="sidebar-footer">
             <button class="btn btn-success btn-block" id="btn-run-analysis">
                <i class="fas fa-play"></i> Run Analysis
            </button>
            <div class="text-center mt-2">
                <small>&copy; 2025 KSTN</small>
            </div>
        </div>
    </nav>
    <div id="content">

        <div id="div_vat_lieu" class="content-section">
            <h2><i class="fas fa-ruler-combined"></i> Vật liệu & Thông số Cọc</h2>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Modul đàn hồi (E, kN/m²):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="vl-E" value="30000000"></div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Momen quán tính (Icoc, m⁴):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="vl-Icoc" value="0.005"></div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Cạnh/Đường kính (D, m):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="vl-D" value="0.4"></div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Diện tích (F, m²):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="vl-F" value="0.16"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Diện tích hữu hiệu (Fh, m²):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="vl-Fh" value="0.16"></div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Chiều dài cọc (Lcoc, m):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="vl-Lcoc" value="15"></div>
                    </div>
                     <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Chiều dài cọc tự do (L0, m):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="vl-L0" value="2.0"></div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Hệ số m (kN/m⁴):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="vl-m" value="1000"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="div_dat_nen" class="content-section">
            <h2><i class="fas fa-layer-group"></i> Thông số Đất nền</h2>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Điều kiện mũi cọc (dieu_kien_mui):</label>
                        <select class="form-control" id="dn-dieu-kien-mui">
                            <option value="K" selected>K (Khớp)</option>
                            <option value="N">N (Ngàm)</option>
                            <option value="T">T (Tự do)</option>
                        </select>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Cường độ đất nền (Rdat, kN/m²):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="dn-Rdat" value="300"></div>
                    </div>
                     <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Hệ số m chân (mchan, kN/m⁴):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="dn-mchan" value="1000"></div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Số lớp đất (nLopDat):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="dn-nLopDat" value="1"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Các lớp đất (từ trên xuống, dưới L0)</h5>
                    <div class="table-responsive" style="max-height: 250px;">
                        <table class="table table-bordered table-hover" id="lop-dat-table">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Lớp</th>
                                    <th>Chiều dày (Ldat, m)</th>
                                    <th>Xóa</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><input type="number" class="form-control" value="13.0"></td>
                                    <td><button class="btn btn-danger btn-sm" onclick="removeRow(this, 'lop-dat-table')"><i class="fas fa-trash"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary" id="btn-add-lop-dat">
                        <i class="fas fa-plus"></i> Thêm lớp đất
                    </button>
                </div>
            </div>
        </div>
        
        <div id="div_be_coc" class="content-section">
            <h2><i class="fas fa-cube"></i> Kích thước Bệ (dùng cho Kiểm toán & Vẽ)</h2>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Kích thước bệ theo X (Bx, m):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="bc-Bx" value="4.0"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Kích thước bệ theo Y (By, m):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="bc-By" value="4.0"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="div_coc" class="content-section">
            <h2><i class="fas fa-th"></i> Vị trí Cọc (Hệ tọa độ O tại tâm bệ)</h2>
            <hr>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="coc-table">
                    <thead class="thead-dark">
                        <tr>
                            <th>Cọc số</th>
                            <th>Tọa độ x (m)</th>
                            <th>Tọa độ y (m)</th>
                            <th>Góc Fi (rad)</th>
                            <th>Góc Psi (rad)</th>
                            <th>Xóa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td><input type="number" class="form-control" value="-1.5"></td>
                            <td><input type="number" class="form-control" value="-1.5"></td>
                            <td><input type="number" class="form-control" value="0"></td>
                            <td><input type="number" class="form-control" value="0"></td>
                            <td><button class="btn btn-danger btn-sm" onclick="removeRow(this, 'coc-table')"><i class="fas fa-trash"></i></button></td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td><input type="number" class="form-control" value="1.5"></td>
                            <td><input type="number" class="form-control" value="-1.5"></td>
                            <td><input type="number" class="form-control" value="0"></td>
                            <td><input type="number" class="form-control" value="0"></td>
                            <td><button class="btn btn-danger btn-sm" onclick="removeRow(this, 'coc-table')"><i class="fas fa-trash"></i></button></td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td><input type="number" class="form-control" value="-1.5"></td>
                            <td><input type="number" class="form-control" value="1.5"></td>
                            <td><input type="number" class="form-control" value="0"></td>
                            <td><input type="number" class="form-control" value="0"></td>
                            <td><button class="btn btn-danger btn-sm" onclick="removeRow(this, 'coc-table')"><i class="fas fa-trash"></i></button></td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td><input type="number" class="form-control" value="1.5"></td>
                            <td><input type="number" class="form-control" value="1.5"></td>
                            <td><input type="number" class="form-control" value="0"></td>
                            <td><input type="number" class="form-control" value="0"></td>
                            <td><button class="btn btn-danger btn-sm" onclick="removeRow(this, 'coc-table')"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button class="btn btn-primary" id="btn-add-coc">
                <i class="fas fa-plus"></i> Thêm Cọc
            </button>
        </div>

        <div id="div_tai_trong" class="content-section">
            <h2><i class="fas fa-truck-loading"></i> Tải trọng tại Tâm bệ</h2>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Lực ngang (Hx, kN):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="tt-Hx" value="100"></div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Lực ngang (Hy, kN):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="tt-Hy" value="150"></div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Lực dọc (Pz, kN):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="tt-Pz" value="5000"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Momen xoắn (Mx, kNm):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="tt-Mx" value="0"></div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Momen uốn (My, kNm):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="tt-My" value="200"></div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label">Momen uốn (Mz, kNm):</label>
                        <div class="col-sm-6"><input type="number" class="form-control" id="tt-Mz" value="300"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="div_license" class="content-section">
            <h2><i class="fas fa-id-card"></i> Quản lý bản quyền</h2>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="user-email">Email đăng ký:</label>
                        <input type="email" class="form-control" id="user-email" placeholder="Nhập email của bạn">
                    </div>
                    <div class="form-group">
                        <label for="license-key">License Key:</label>
                        <input type="text" class="form-control" id="license-key" placeholder="Nhập license key">
                    </div>
                    <button class="btn btn-primary" id="btn-check-license">
                        <i class="fas fa-check-circle"></i> Kiểm tra
                    </button>
                    <div id="license-status" class="mt-3 alert alert-secondary">
                        Trạng thái: Chưa kích hoạt
                    </div>
                </div>
            </div>
        </div>
        
        <div id="output-section" class="mt-4" style="display: none;">
            <h2>Kết quả phân tích</h2>
            <hr>
            <div class="alert alert-danger" id="error-message" style="display: none;"></div>
            <div id="loading-spinner" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <span>Đang tính toán...</span>
            </div>
            
            <div id="results-content" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Chuyển vị đài cọc</h4>
                        <table class="table table-bordered table-sm" id="chuyen_vi_table">
                            </table>
                        
                        <h4 class="mt-3">Kiểm tra Cân bằng lực</h4>
                        <table class="table table-bordered table-sm" id="kiem_tra_luc_table">
                            </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h4>Mặt bằng móng cọc (Plan View)</h4>
                        <canvas id="pile-cap-canvas" width="400" height="400"></canvas>
                        
                        <h4 class="mt-3">Kiểm toán móng khối</h4>
                        <table class="table table-bordered table-sm" id="kiem_toan_table">
                             </table>
                    </div>
                </div>
                
                <h4 class="mt-4">Nội lực tại đầu cọc</h4>
                <div class="table-responsive" id="noi_luc_coc_table">
                    </div>
            </div>
        </div>

    </div>
    </div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script src="pilegroup.js"></script>

<script src="app-check.js"></script>
<script src="app-cal.js"></script>
<script src="app-out.js"></script>

<script>
$(document).ready(function () {
    // Hàm xử lý khi click vào link trên sidebar
    $('#sidebar .sidebar-link').on('click', function (e) {
        e.preventDefault(); 
        var targetId = $(this).data('target');
        
        $('#content > .content-section').hide();
        $('#' + targetId).show();
        
        $('#sidebar ul li').removeClass('active');
        $(this).parent('li').addClass('active');
    });

    // Tự động click vào mục đầu tiên khi tải trang
    $('#sidebar .sidebar-link[data-target=\'div_vat_lieu\']').first().click();
    
    // Xử lý nút "Check License" trên sidebar
    $('#btn-check-license-sidebar').on('click', function() {
        $('#sidebar a[data-target="div_license"]').click();
    });

    // --- Logic thêm/xóa hàng (Cập nhật) ---

    // Thêm Lớp đất
    $("#btn-add-lop-dat").click(function () {
        var tableId = 'lop-dat-table';
        var rowCount = $('#' + tableId + ' tbody tr').length + 1;
        var newRow = '<tr>' +
            '<td>' + rowCount + '</td>' +
            '<td><input type="number" class="form-control" value="0"></td>' +
            '<td><button class="btn btn-danger btn-sm" onclick="removeRow(this, \'' + tableId + '\')"><i class="fas fa-trash"></i></button></td>' +
            '</tr>';
        $('#' + tableId + ' tbody').append(newRow);
    });

    // Thêm Cọc
    $("#btn-add-coc").click(function () {
        var tableId = 'coc-table';
        var rowCount = $('#' + tableId + ' tbody tr').length + 1;
        var newRow = '<tr>' +
            '<td>' + rowCount + '</td>' +
            '<td><input type="number" class="form-control" value="0"></td>' +
            '<td><input type="number" class="form-control" value="0"></td>' +
            '<td><input type="number" class="form-control" value="0"></td>' +
            '<td><input type="number" class="form-control" value="0"></td>' +
            '<td><button class="btn btn-danger btn-sm" onclick="removeRow(this, \'' + tableId + '\')"><i class="fas fa-trash"></i></button></td>' +
            '</tr>';
        $('#' + tableId + ' tbody').append(newRow);
    });
});

// Hàm xóa hàng (global) - Cập nhật để đánh STT
function removeRow(button, tableId) {
    $(button).closest('tr').remove();
    // Cập nhật lại số thứ tự (STT)
    $('#' + tableId + ' tbody tr').each(function(index) {
        $(this).find('td:first').text(index + 1);
    });
}
</script>

</body>
</html>