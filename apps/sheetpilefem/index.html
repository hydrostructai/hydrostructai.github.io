<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheet Pile FEM Analysis</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <style>
        body { background-color: #f0f2f5; }
        .card { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .nav-tabs .nav-link { color: #495057; }
        .nav-tabs .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-bottom-color: #0d6efd;
        }
        /* Nền xanh nhạt cho sidebar */
        .sidebar-card {
            background-color: #e6f7ff; 
        }
        /* Bảng cuộn */
        .table-scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .table-scroll-container thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
        }
        /* Ẩn spinner (dùng cho nút Run) */
        .spinner-border { display: none; }
        /* Căn chỉnh input trong bảng */
        td input[type="number"] {
            width: 100%;
            border: 1px solid #ddd;
            padding: 4px;
            border-radius: 4px;
        }
        td input[type="number"]:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 2px rgba(13,110,253,.25);
        }
        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        #loading-overlay .spinner {
            width: 80px;
            height: 80px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-overlay .loading-text {
            color: white;
            font-size: 1.5rem;
            margin-top: 20px;
            font-weight: 500;
        }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">
        <i class="bi bi-hourglass-split"></i> Đang tải lõi tính toán (WASM)...
    </div>
</div>

<div class="container my-4">
    <div class="row">
        <div class="col-lg-3 mb-4">
                <div class="card p-3 sticky-top sidebar-card" style="top: 1rem;">
                    <h4><i class="bi bi-robot text-primary"></i> Điều khiển</h4>
                    <hr>
                    
                    <!-- File Management Toolbar -->
                    <div class="btn-group w-100 mb-3" role="group">
                        <button type="button" class="btn btn-outline-primary" id="btn-new-file" title="Tạo mới">
                            <i class="bi bi-file-earmark-plus"></i> New
                        </button>
                        <button type="button" class="btn btn-outline-success" id="btn-open-file" title="Mở file">
                            <i class="bi bi-folder-open"></i> Open
                        </button>
                        <button type="button" class="btn btn-outline-warning" id="btn-save-file" title="Lưu file">
                            <i class="bi bi-save"></i> Save
                        </button>
                    </div>
                    <input type="file" id="hidden-file-input" accept=".csv,.inp" style="display:none;">
                    
                    <button class="btn btn-lg btn-success w-100" id="btn-run-analysis" disabled>
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="calc-spinner"></span>
                        <i class="bi bi-calculator"></i> Run Analysis
                    </button>
                
                <div class="alert alert-info mt-3" id="wasm-status">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary me-2" role="status" id="wasm-spinner"></div>
                        <span id="wasm-status-text">Đang tải lõi tính toán (Wasm)...</span>
                    </div>
                </div>
                <div class="alert alert-danger mt-3" id="error-message" style="display: none;"></div>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Phân tích Tường cừ (Sheet Pile FEM)</h3>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="inputTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-general" data-bs-toggle="tab" data-bs-target="#content-general" type="button">1. Thông số chung</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-layers" data-bs-toggle="tab" data-bs-target="#content-layers" type="button">2. Lớp đất</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-anchors" data-bs-toggle="tab" data-bs-target="#content-anchors" type="button">3. Neo / Chống</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-loads" data-bs-toggle="tab" data-bs-target="#content-loads" type="button">4. Tải tập trung</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-water" data-bs-toggle="tab" data-bs-target="#content-water" type="button">5. Mực nước</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-surcharge" data-bs-toggle="tab" data-bs-target="#content-surcharge" type="button">6. Tải phân bố</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-license" data-bs-toggle="tab" data-bs-target="#content-license" type="button"><i class="bi bi-patch-check"></i> 7. Bản quyền</button>
                        </li>
                    </ul>

                    <div class="tab-content p-3 border border-top-0" id="inputTabsContent">
                        
                        <div class="tab-pane fade show active" id="content-general" role="tabpanel">
                            <h5><i class="bi bi-bricks"></i> 1. Wall Properties (Thông số tường cừ)</h5>
                            <hr>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Nhập đặc trưng của tường cừ thép/bê tông
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-calculator"></i> Độ cứng EI (kN·m²/m):
                                        <span class="text-muted fw-normal">(E × I)</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control form-control-lg" id="general-EI" value="67200" step="1000">
                                        <span class="input-group-text">kN·m²/m</span>
                                    </div>
                                    <small class="text-muted">Hoặc nhập riêng:</small>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <label class="form-label">E (kN/m²):</label>
                                            <input type="number" class="form-control" id="general-E" value="210000000" readonly>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">I (m⁴/m):</label>
                                            <input type="number" class="form-control" id="general-I" value="0.00032" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-arrows-vertical"></i> Chiều dài tường (L, m):
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control form-control-lg" id="general-L" value="15" step="0.5" min="1">
                                        <span class="input-group-text">m</span>
                                    </div>
                                    <small class="text-muted">Tổng chiều dài từ đầu tường đến chân tường</small>
                                </div>
                            </div>
                            
                            <h5 class="mt-4"><i class="bi bi-cone-striped"></i> 2. Excavation Stage (Giai đoạn đào)</h5>
                            <hr>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-arrow-down-circle"></i> Độ sâu đào (H, m):
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control form-control-lg" id="general-H" value="5" step="0.5" min="0">
                                        <span class="input-group-text">m</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-droplet"></i> Mực nước phía sau (Hw1, m):
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control form-control-lg" id="water-hw1" value="5" step="0.5">
                                        <span class="input-group-text">m</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-droplet-half"></i> Mực nước phía trước (Hw2, m):
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control form-control-lg" id="water-hw2" value="1" step="0.5">
                                        <span class="input-group-text">m</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="content-layers" role="tabpanel">
                            <h5><i class="bi bi-layers-fill"></i> Soil Layers (Các lớp đất nền)</h5>
                            <hr>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> <strong>Phiên bản FREE:</strong> Giới hạn 2 lớp đất. 
                                <a href="#" class="alert-link" onclick="document.getElementById('tab-license').click()">Kích hoạt PRO</a> để sử dụng không giới hạn.
                            </div>
                            <div class="table-scroll-container">
                                <table class="table table-bordered table-hover table-striped" id="soil-layer-table">
                                    <thead class="table-primary">
                                        <tr>
                                            <th style="width: 60px;">STT</th>
                                            <th>
                                                <i class="bi bi-arrows-vertical"></i> Cao độ đáy lớp<br>
                                                <small class="fw-normal">(Depth, m)</small>
                                            </th>
                                            <th>
                                                <i class="bi bi-box-fill"></i> γ<br>
                                                <small class="fw-normal">(kN/m³)</small>
                                            </th>
                                            <th>
                                                <i class="bi bi-water"></i> γ'<br>
                                                <small class="fw-normal">(kN/m³)</small>
                                            </th>
                                            <th>
                                                <i class="bi bi-triangle"></i> φ<br>
                                                <small class="fw-normal">(độ)</small>
                                            </th>
                                            <th>
                                                <i class="bi bi-grip-horizontal"></i> c'<br>
                                                <small class="fw-normal">(kN/m²)</small>
                                            </th>
                                            <th>
                                                <i class="bi bi-speedometer"></i> k<br>
                                                <small class="fw-normal">(kN/m³)</small>
                                            </th>
                                            <th style="width: 80px;">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-center fw-bold">1</td>
                                            <td><input type="number" class="form-control" value="5" step="0.5" required></td>
                                            <td><input type="number" class="form-control" value="18" step="0.1" required></td>
                                            <td><input type="number" class="form-control" value="8" step="0.1" required></td>
                                            <td><input type="number" class="form-control" value="30" step="1" required></td>
                                            <td><input type="number" class="form-control" value="0" step="1" required></td>
                                            <td><input type="number" class="form-control" value="10000" step="1000" required></td>
                                            <td class="text-center">
                                                <button class="btn btn-outline-danger btn-sm" onclick="removeRow(this)" title="Xóa lớp">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-center fw-bold">2</td>
                                            <td><input type="number" class="form-control" value="15" step="0.5" required></td>
                                            <td><input type="number" class="form-control" value="19" step="0.1" required></td>
                                            <td><input type="number" class="form-control" value="9" step="0.1" required></td>
                                            <td><input type="number" class="form-control" value="32" step="1" required></td>
                                            <td><input type="number" class="form-control" value="0" step="1" required></td>
                                            <td><input type="number" class="form-control" value="15000" step="1000" required></td>
                                            <td class="text-center">
                                                <button class="btn btn-outline-danger btn-sm" onclick="removeRow(this)" title="Xóa lớp">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <button class="btn btn-success btn-lg mt-3" id="btn-add-layer">
                                <i class="bi bi-plus-circle-fill"></i> Thêm lớp đất mới
                            </button>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-lightbulb"></i> <strong>Ghi chú:</strong>
                                    <ul class="mb-0">
                                        <li>γ: Dung trọng tự nhiên của đất</li>
                                        <li>γ': Dung trọng đẩy nổi (submerged)</li>
                                        <li>φ: Góc ma sát trong</li>
                                        <li>c': Lực dính hiệu dụng</li>
                                        <li>k: Hệ số phản lực nền (Subgrade reaction modulus)</li>
                                    </ul>
                                </small>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="content-anchors" role="tabpanel">
                            <h5><i class="bi bi-anchor"></i> Struts/Anchors (Neo/Chống)</h5>
                            <hr>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Danh sách các neo/chống tựa cho tường cừ
                            </div>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> <strong>Phiên bản FREE:</strong> Giới hạn 1 neo. 
                                <a href="#" class="alert-link" onclick="document.getElementById('tab-license').click()">Kích hoạt PRO</a> để không giới hạn.
                            </div>
                            <div class="table-scroll-container">
                                <table class="table table-bordered table-hover table-striped" id="anchor-table">
                                    <thead class="table-primary">
                                        <tr>
                                            <th style="width: 60px;">STT</th>
                                            <th>
                                                <i class="bi bi-arrows-vertical"></i> Độ sâu (Depth)<br>
                                                <small class="fw-normal">(m)</small>
                                            </th>
                                            <th>
                                                <i class="bi bi-gear-wide-connected"></i> Độ cứng (K)<br>
                                                <small class="fw-normal">(kN/m/m)</small>
                                            </th>
                                            <th style="width: 80px;">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- START WITH 0 ROWS AS PER REQUIREMENT -->
                                    </tbody>
                                </table>
                            </div>
                            <button class="btn btn-success btn-lg mt-3" id="btn-add-anchor">
                                <i class="bi bi-plus-circle-fill"></i> Thêm Neo/Chống
                            </button>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-lightbulb"></i> <strong>Ghi chú:</strong> Neo/chống là các điểm tựa giúp giữ tường cừ ổn định. Độ cứng K thể hiện khả năng chống lại chuyển vị.
                                </small>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="content-loads" role="tabpanel">
                            <h5><i class="bi bi-bullseye"></i> Point Loads (Tải trọng tập trung)</h5>
                            <hr>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Tải trọng tập trung tác dụng lên tường cừ (ví dụ: tải từ cột, dầm)
                            </div>
                            <div class="table-scroll-container">
                                <table class="table table-bordered table-hover table-striped" id="load-table">
                                    <thead class="table-primary">
                                        <tr>
                                            <th style="width: 60px;">STT</th>
                                            <th>
                                                <i class="bi bi-arrows-vertical"></i> Độ sâu (Depth)<br>
                                                <small class="fw-normal">(m)</small>
                                            </th>
                                            <th>
                                                <i class="bi bi-arrow-down-circle"></i> Tải trọng (Load)<br>
                                                <small class="fw-normal">(kN/m)</small>
                                            </th>
                                            <th style="width: 80px;">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dynamic rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                            <button class="btn btn-success btn-lg mt-3" id="btn-add-load">
                                <i class="bi bi-plus-circle-fill"></i> Thêm Tải trọng
                            </button>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-lightbulb"></i> <strong>Ghi chú:</strong> Giá trị mặc định khi thêm: <strong>10 kN/m</strong>
                                </small>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="content-water" role="tabpanel">
                            <h5><i class="bi bi-droplet-half"></i> Water Levels (Mực nước ngầm)</h5>
                            <hr>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Mực nước tính từ mặt đất gốc (Ground Level = 0)
                            </div>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-arrow-bar-left text-primary"></i> Mực nước phía sau tường (Hw1)
                                            </h6>
                                            <div class="input-group input-group-lg">
                                                <input type="number" class="form-control" id="water-hw1" value="5" step="0.5">
                                                <span class="input-group-text">m</span>
                                            </div>
                                            <small class="text-muted">Độ sâu mực nước phía đất giữ lại</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-arrow-bar-right text-success"></i> Mực nước phía trước tường (Hw2)
                                            </h6>
                                            <div class="input-group input-group-lg">
                                                <input type="number" class="form-control" id="water-hw2" value="1" step="0.5">
                                                <span class="input-group-text">m</span>
                                            </div>
                                            <small class="text-muted">Độ sâu mực nước phía khu đào</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="content-surcharge" role="tabpanel">
                            <h5><i class="bi bi-arrow-down-square"></i> Distributed Loads (Tải phân bố/Surcharge)</h5>
                            <hr>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Tải trọng phân đều tác dụng lên mặt đất (ví dụ: tải xe, kho hàng, nhà kho)
                            </div>
                            <div class="table-scroll-container">
                                <table class="table table-bordered table-hover table-striped" id="surcharge-table">
                                    <thead class="table-primary">
                                        <tr>
                                            <th style="width: 60px;">STT</th>
                                            <th>
                                                <i class="bi bi-arrow-down-circle"></i> Bắt đầu (z_start)<br>
                                                <small class="fw-normal">(m)</small>
                                            </th>
                                            <th>
                                                <i class="bi bi-arrow-down-circle-fill"></i> Kết thúc (z_end)<br>
                                                <small class="fw-normal">(m)</small>
                                            </th>
                                            <th>
                                                <i class="bi bi-box-fill"></i> Giá trị (q)<br>
                                                <small class="fw-normal">(kN/m²)</small>
                                            </th>
                                            <th style="width: 80px;">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-center fw-bold">1</td>
                                            <td><input type="number" class="form-control" value="0" step="0.5" required></td>
                                            <td><input type="number" class="form-control" value="5" step="0.5" required></td>
                                            <td><input type="number" class="form-control" value="6" step="0.5" required></td>
                                            <td class="text-center">
                                                <button class="btn btn-outline-danger btn-sm" onclick="removeRow(this)" title="Xóa">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <button class="btn btn-success btn-lg mt-3" id="btn-add-surcharge">
                                <i class="bi bi-plus-circle-fill"></i> Thêm Tải phân bố
                            </button>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-lightbulb"></i> <strong>Ghi chú:</strong> Giá trị mặc định khi thêm: <strong>6 kN/m²</strong> (tải phân bố đều)
                                </small>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="content-license" role="tabpanel">
                            <h5><i class="bi bi-patch-check-fill"></i> License Management (Quản lý bản quyền)</h5>
                            <hr>
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="card shadow-sm">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="bi bi-key-fill"></i> Kích hoạt bản quyền PRO</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="user-email" class="form-label fw-bold">
                                                    <i class="bi bi-envelope"></i> Email đăng ký:
                                                </label>
                                                <input type="email" class="form-control form-control-lg" id="user-email" 
                                                       placeholder="your.email@example.com" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="license-key" class="form-label fw-bold">
                                                    <i class="bi bi-key"></i> License Key:
                                                </label>
                                                <input type="text" class="form-control form-control-lg" id="license-key" 
                                                       placeholder="XXXX-XXXX-XXXX-XXXX" style="font-family: monospace;" required>
                                                <small class="text-muted">
                                                    <i class="bi bi-lightbulb"></i> Để test, nhập key chứa "valid" hoặc "pro"
                                                </small>
                                            </div>
                                            <button class="btn btn-primary btn-lg w-100" id="btn-check-license">
                                                <i class="bi bi-check-circle-fill"></i> Kích hoạt bản quyền
                                            </button>
                                        </div>
                                    </div>
                                    <div id="license-status" class="mt-3 alert alert-secondary">
                                        <i class="bi bi-info-circle"></i> Trạng thái: Chưa kích hoạt. Giới hạn 2 lớp đất.
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="card border-warning shadow-sm">
                                        <div class="card-header bg-warning">
                                            <h6 class="mb-0"><i class="bi bi-star-fill"></i> Phiên bản PRO</h6>
                                        </div>
                                        <div class="card-body">
                                            <h6 class="text-primary">Các tính năng:</h6>
                                            <ul class="list-unstyled">
                                                <li><i class="bi bi-check-circle-fill text-success"></i> Không giới hạn số lớp đất</li>
                                                <li><i class="bi bi-check-circle-fill text-success"></i> Không giới hạn neo/chống</li>
                                                <li><i class="bi bi-check-circle-fill text-success"></i> Xuất báo cáo chi tiết</li>
                                                <li><i class="bi bi-check-circle-fill text-success"></i> Hỗ trợ kỹ thuật ưu tiên</li>
                                            </ul>
                                            <hr>
                                            <h6 class="text-danger">Phiên bản FREE:</h6>
                                            <ul class="list-unstyled">
                                                <li><i class="bi bi-x-circle text-danger"></i> Tối đa 2 lớp đất</li>
                                                <li><i class="bi bi-check-circle text-secondary"></i> Các tính năng cơ bản</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
            <div id="output-section" class="card mt-4" style="display: none;">
                <div class="card-header">
                     <h3 class="mb-0">Kết quả phân tích</h3>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-charts" data-bs-toggle="tab" data-bs-target="#content-charts" type="button">Biểu đồ</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-summary" data-bs-toggle="tab" data-bs-target="#content-summary" type="button">Tóm tắt</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content p-3 border border-top-0">
                        <div class="tab-pane fade show active" id="content-charts" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6"><canvas id="chart-displacement"></canvas></div>
                                <div class="col-md-6"><canvas id="chart-moment"></canvas></div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6"><canvas id="chart-shear"></canvas></div>
                                <div class="col-md-6"><canvas id="chart-pressure"></canvas></div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="content-summary" role="tabpanel">
                            <h4>Kết quả chi tiết</h4>
                            <pre id="json-output" style="background: #eee; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto;"></pre>
<button class="btn btn-sm btn-outline-success" id="btn-export-csv"><i class="bi bi-file-earmark-ruled"></i> Xuất CSV</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="sheetpilefem.js"></script>

<script src="app-check.js"></script>
<script src="app-cal.js"></script>
<script src="app-out.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Logic cho các nút Add/Remove (giữ nguyên, chỉ đổi icon)
    
    // Thêm lớp đất
    document.getElementById("btn-add-layer").addEventListener("click", () => {
        const tableBody = document.querySelector('#soil-layer-table tbody');
        const rowCount = tableBody.rows.length + 1;
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
            <td>${rowCount}</td>
            <td><input type="number" class="form-control" value="0"></td>
            <td><input type="number" class="form-control" value="18"></td>
            <td><input type="number" class="form-control" value="8"></td>
            <td><input type="number" class="form-control" value="30"></td>
            <td><input type="number" class="form-control" value="0"></td>
            <td><input type="number" class="form-control" value="10000"></td>
            <td><button class="btn btn-danger btn-sm" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
        `;
    });

    // Thêm Neo/Chống (with FREE tier validation)
    document.getElementById("btn-add-anchor").addEventListener("click", () => {
        const tableBody = document.querySelector('#anchor-table tbody');
        const rowCount = tableBody.rows.length;
        
        // Check FREE tier restriction
        const isLicensed = localStorage.getItem('sheetpileLicensed') === 'true';
        if (!isLicensed && rowCount >= 1) {
            alert("⚠️ Phiên bản FREE chỉ cho phép tối đa 1 neo/chống.\n\nVui lòng nâng cấp lên PRO để sử dụng không giới hạn.");
            document.getElementById('tab-license').click();
            return;
        }
        
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
            <td class="text-center fw-bold">${rowCount + 1}</td>
            <td><input type="number" class="form-control" value="2" step="0.5" required></td>
            <td><input type="number" class="form-control" value="50000" step="1000" required></td>
            <td class="text-center">
                <button class="btn btn-outline-danger btn-sm" onclick="removeRow(this)" title="Xóa">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
    });

    // Thêm Tải trọng tập trung (DEFAULT: 10 kN/m)
    document.getElementById("btn-add-load").addEventListener("click", () => {
        const tableBody = document.querySelector('#load-table tbody');
        const rowCount = tableBody.rows.length + 1;
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
            <td class="text-center fw-bold">${rowCount}</td>
            <td><input type="number" class="form-control" value="0" step="0.5" required></td>
            <td><input type="number" class="form-control" value="10" step="0.5" required></td>
            <td class="text-center">
                <button class="btn btn-outline-danger btn-sm" onclick="removeRow(this)" title="Xóa">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
    });
    
    // Thêm Tải phân bố (DEFAULT: 6 kN/m²)
    document.getElementById("btn-add-surcharge").addEventListener("click", () => {
        const tableBody = document.querySelector('#surcharge-table tbody');
        const rowCount = tableBody.rows.length + 1;
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
            <td class="text-center fw-bold">${rowCount}</td>
            <td><input type="number" class="form-control" value="0" step="0.5" required></td>
            <td><input type="number" class="form-control" value="5" step="0.5" required></td>
            <td><input type="number" class="form-control" value="6" step="0.5" required></td>
            <td class="text-center">
                <button class="btn btn-outline-danger btn-sm" onclick="removeRow(this)" title="Xóa">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
    });

});

// Hàm xóa hàng (global)
function removeRow(button) {
    button.closest('tr').remove();
    // Cần một hàm cập nhật lại STT của các hàng (có thể bổ sung sau)
}
</script>

</body>
</html>